import { __assign, __decorate, __read, __spread } from "tslib";
import { Component, OnInit, AfterViewInit, AfterViewChecked, OnDestroy, ViewEncapsulation, Input, ViewChild, ComponentRef, TemplateRef, ComponentFactoryResolver, ViewContainerRef, ChangeDetectorRef } from '@angular/core';
import { BlockUIInstanceService } from '../../services/block-ui-instance.service';
import { BlockUIActions } from '../../constants/block-ui-actions.constant';
import { BlockUIDefaultName } from '../../constants/block-ui-default-name.constant';
import { styles } from './block-ui-content.component.style';
import { template } from './block-ui-content.component.template';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../services/block-ui-instance.service';
import * as ɵngcc2 from '@angular/common';

var _c0 = ["templateOutlet"];
function BlockUIContentComponent_div_1_div_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 6);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    var ctx_r2 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ctx_r2.message || ctx_r2.defaultMessage, " ");
} }
function BlockUIContentComponent_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 3);
    ɵngcc0.ɵɵelement(1, "div", 4);
    ɵngcc0.ɵɵtemplate(2, BlockUIContentComponent_div_1_div_2_Template, 2, 1, "div", 5);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    var ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.message || ctx_r0.defaultMessage);
} }
function BlockUIContentComponent_2_ng_template_0_Template(rf, ctx) { }
function BlockUIContentComponent_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtemplate(0, BlockUIContentComponent_2_ng_template_0_Template, 0, 0, "ng-template", null, 7, ɵngcc0.ɵɵtemplateRefExtractor);
} }
var _c1 = function (a0) { return { "active": a0 }; };
var BlockUIContentComponent = /** @class */ (function () {
    function BlockUIContentComponent(blockUI, resolver, changeDetectionRef) {
        this.blockUI = blockUI;
        this.resolver = resolver;
        this.changeDetectionRef = changeDetectionRef;
        this.name = BlockUIDefaultName;
        this.defaultBlockState = {
            startTimeouts: [],
            stopTimeouts: [],
            updateTimeouts: [],
            blockCount: 0,
            startCallCount: 0,
            stopCallCount: 0
        };
        this.state = __assign({}, this.defaultBlockState);
    }
    BlockUIContentComponent.prototype.ngOnInit = function () {
        this.settings = this.blockUI.getSettings();
        this.blockUISubscription = this.subscribeToBlockUI(this.blockUI.observe());
    };
    BlockUIContentComponent.prototype.ngAfterViewInit = function () {
        try {
            if (!this.templateCmp) {
                return false;
            }
            if (this.templateCmp instanceof TemplateRef) {
                this.templateOutlet.createEmbeddedView(this.templateCmp);
            }
            else {
                var templateComp = this.resolver.resolveComponentFactory(this.templateCmp);
                this.templateCompRef = this.templateOutlet.createComponent(templateComp);
                this.updateBlockTemplate(this.message);
            }
        }
        catch (error) {
            console.error('ng-block-ui:', error);
        }
    };
    BlockUIContentComponent.prototype.ngAfterViewChecked = function () {
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.subscribeToBlockUI = function (blockUI$) {
        var _this = this;
        return blockUI$.subscribe(function (event) { return _this.onDispatchedEvent(event); });
    };
    BlockUIContentComponent.prototype.onDispatchedEvent = function (event) {
        switch (event.action) {
            case BlockUIActions.START:
                this.onStart(event);
                break;
            case BlockUIActions.STOP:
                this.onStop(event);
                break;
            case BlockUIActions.UPDATE:
                this.onUpdate(event);
                break;
            case BlockUIActions.RESET:
                this.onReset(event);
                break;
            case BlockUIActions.RESET_GLOBAL:
                this.resetState();
                break;
            case BlockUIActions.UNSUBSCRIBE:
                this.onStop(event);
                this.onUnsubscribe(event.name);
                break;
        }
    };
    BlockUIContentComponent.prototype.onStart = function (_a) {
        var _this = this;
        var name = _a.name, message = _a.message;
        if (name === this.name) {
            var delay = this.delayStart || this.settings.delayStart || 0;
            this.state.startCallCount += 1;
            var startTimeout = setTimeout(function () {
                _this.state.blockCount += 1;
                _this.showBlock(message);
                _this.updateInstanceBlockCount();
            }, delay);
            this.state.startTimeouts.push(startTimeout);
        }
    };
    BlockUIContentComponent.prototype.onStop = function (_a) {
        var _this = this;
        var name = _a.name;
        if (name === this.name) {
            var stopCount = this.state.stopCallCount + 1;
            if (this.state.startCallCount - stopCount >= 0) {
                var delay = this.delayStop || this.settings.delayStop || 0;
                this.state.stopCallCount = stopCount;
                var stopTimeout = setTimeout(function () {
                    _this.state.blockCount -= 1;
                    _this.updateInstanceBlockCount();
                    _this.detectChanges();
                }, delay);
                this.state.stopTimeouts.push(stopTimeout);
            }
        }
    };
    BlockUIContentComponent.prototype.onUpdate = function (_a) {
        var _this = this;
        var name = _a.name, message = _a.message;
        if (name === this.name) {
            var delay = this.delayStart || this.settings.delayStart || 0;
            clearTimeout(this.state.updateTimeouts[0]);
            var updateTimeout = setTimeout(function () {
                _this.updateMessage(message);
            }, delay);
            this.state.updateTimeouts.push(updateTimeout);
        }
    };
    BlockUIContentComponent.prototype.onReset = function (_a) {
        var name = _a.name;
        if (name === this.name) {
            this.resetState();
        }
    };
    BlockUIContentComponent.prototype.updateMessage = function (message) {
        this.showBlock(message);
    };
    BlockUIContentComponent.prototype.showBlock = function (message) {
        this.message = message || this.defaultMessage || this.settings.message;
        this.updateBlockTemplate(this.message);
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.updateBlockTemplate = function (msg) {
        if (this.templateCompRef && this.templateCompRef instanceof ComponentRef) {
            this.templateCompRef.instance.message = msg;
        }
    };
    BlockUIContentComponent.prototype.resetState = function () {
        __spread(this.state.startTimeouts, this.state.stopTimeouts, this.state.updateTimeouts).forEach(clearTimeout);
        this.state = __assign({}, this.defaultBlockState);
        this.updateInstanceBlockCount();
        this.detectChanges();
    };
    BlockUIContentComponent.prototype.onUnsubscribe = function (name) {
        if (this.blockUISubscription && name === this.name) {
            this.blockUISubscription.unsubscribe();
        }
    };
    BlockUIContentComponent.prototype.updateInstanceBlockCount = function () {
        if (this.blockUI.blockUIInstances[this.name]) {
            var blockCount = this.state.blockCount;
            this.blockUI.blockUIInstances[this.name].blockCount = blockCount;
        }
    };
    BlockUIContentComponent.prototype.detectChanges = function () {
        if (!this.changeDetectionRef['destroyed']) {
            this.changeDetectionRef.detectChanges();
        }
    };
    BlockUIContentComponent.prototype.ngOnDestroy = function () {
        this.resetState();
        this.onUnsubscribe(this.name);
        this.blockUI.clearInstance(this.name);
    };
    BlockUIContentComponent.ctorParameters = function () { return [
        { type: BlockUIInstanceService },
        { type: ComponentFactoryResolver },
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "name", void 0);
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "delayStart", void 0);
    __decorate([
        Input()
    ], BlockUIContentComponent.prototype, "delayStop", void 0);
    __decorate([
        Input('message')
    ], BlockUIContentComponent.prototype, "defaultMessage", void 0);
    __decorate([
        Input('template')
    ], BlockUIContentComponent.prototype, "templateCmp", void 0);
    __decorate([
        ViewChild('templateOutlet', { read: ViewContainerRef })
    ], BlockUIContentComponent.prototype, "templateOutlet", void 0);
BlockUIContentComponent.ɵfac = function BlockUIContentComponent_Factory(t) { return new (t || BlockUIContentComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BlockUIInstanceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef)); };
BlockUIContentComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: BlockUIContentComponent, selectors: [["block-ui-content"]], viewQuery: function BlockUIContentComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(_c0, 1, ViewContainerRef);
    } if (rf & 2) {
        var _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.templateOutlet = _t.first);
    } }, inputs: { name: "name", delayStart: "delayStart", delayStop: "delayStop", defaultMessage: ["message", "defaultMessage"], templateCmp: ["template", "templateCmp"] }, decls: 3, vars: 9, consts: [[3, "ngClass"], ["class", "block-ui-spinner", 4, "ngIf"], [4, "ngIf"], [1, "block-ui-spinner"], [1, "loader"], ["class", "message", 4, "ngIf"], [1, "message"], ["templateOutlet", ""]], template: function BlockUIContentComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵtemplate(1, BlockUIContentComponent_div_1_Template, 3, 1, "div", 1);
        ɵngcc0.ɵɵtemplate(2, BlockUIContentComponent_2_Template, 2, 0, undefined, 2);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵclassMapInterpolate2("block-ui-wrapper ", ctx.name, " ", ctx.className, "");
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(7, _c1, ctx.state.blockCount > 0));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.templateCmp);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.templateCmp);
    } }, directives: [ɵngcc2.NgClass, ɵngcc2.NgIf], styles: ["\n.block-ui-wrapper {\n  display: none;\n  position: fixed;\n  height: 100%;\n  width: 100%;\n  top: 0;\n  left: 0;\n  background: rgba(0, 0, 0, 0.70);\n  z-index: 30000;\n  cursor: wait;\n}\n\n.block-ui-wrapper.block-ui-wrapper--element {\n  position: absolute;\n}\n\n.block-ui-wrapper.active {\n  display: block;\n}\n\n.block-ui-wrapper.block-ui-main {\n  position: fixed;\n}\n\n.block-ui-spinner,\n.block-ui-template {\n  position: absolute;\n  top: 40%;\n  margin: 0 auto;\n  left: 0;\n  right: 0;\n  transform: translateY(-50%);\n}\n\n.block-ui-spinner > .message {\n  font-size: 1.3em;\n  text-align: center;\n  color: #fff;\n}\n\n.block-ui__element {\n  position: relative;\n}\n\n.loader,\n.loader:after {\n  border-radius: 50%;\n  width: 10em;\n  height: 10em;\n}\n.loader {\n  margin: 7px auto;\n  font-size: 5px;\n  position: relative;\n  text-indent: -9999em;\n  border-top: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-right: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-left: 1.1em solid #ffffff;\n  -webkit-transform: translateZ(0);\n  -ms-transform: translateZ(0);\n  transform: translateZ(0);\n  -webkit-animation: load8 1.1s infinite linear;\n  animation: load8 1.1s infinite linear;\n}\n\n@-webkit-keyframes load8 {\n  0% {\n    -webkit-transform: rotate(0deg);\n    transform: rotate(0deg);\n  }\n  100% {\n    -webkit-transform: rotate(360deg);\n    transform: rotate(360deg);\n  }\n}\n\n@keyframes load8 {\n  0% {\n    -webkit-transform: rotate(0deg);\n    transform: rotate(0deg);\n  }\n  100% {\n    -webkit-transform: rotate(360deg);\n    transform: rotate(360deg);\n  }\n}\n"], encapsulation: 2 });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(BlockUIContentComponent, [{
        type: Component,
        args: [{
                selector: 'block-ui-content',
                template: template,
                encapsulation: ViewEncapsulation.None,
                styles: [styles]
            }]
    }], function () { return [{ type: ɵngcc1.BlockUIInstanceService }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc0.ChangeDetectorRef }]; }, { name: [{
            type: Input
        }], delayStart: [{
            type: Input
        }], delayStop: [{
            type: Input
        }], defaultMessage: [{
            type: Input,
            args: ['message']
        }], templateCmp: [{
            type: Input,
            args: ['template']
        }], templateOutlet: [{
            type: ViewChild,
            args: ['templateOutlet', { read: ViewContainerRef }]
        }] }); })();
    return BlockUIContentComponent;
}());
export { BlockUIContentComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWktY29udGVudC5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIm5nLWJsb2NrLXVpL2NvbXBvbmVudHMvYmxvY2stdWktY29udGVudC9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sYUFBYSxFQUNiLGdCQUFnQixFQUNoQixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFdBQVcsRUFDWCx3QkFBd0IsRUFDeEIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVsRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDcEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBa0JqRTtBQUEyRCxJQXlCekQsaUNBQ1UsT0FBK0IsRUFDL0IsUUFBa0MsRUFDbEMsa0JBQXFDO0FBQzlDLFFBSFMsWUFBTyxHQUFQLE9BQU8sQ0FBd0I7QUFBQyxRQUNoQyxhQUFRLEdBQVIsUUFBUSxDQUEwQjtBQUFDLFFBQ25DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBbUI7QUFDakQsUUE1QlcsU0FBSSxHQUFXLGtCQUFrQixDQUFDO0FBQzdDLFFBT0Usc0JBQWlCLEdBQWU7QUFDbEMsWUFBSSxhQUFhLEVBQUUsRUFBRTtBQUNyQixZQUFJLFlBQVksRUFBRSxFQUFFO0FBQ3BCLFlBQUksY0FBYyxFQUFFLEVBQUU7QUFDdEIsWUFBSSxVQUFVLEVBQUUsQ0FB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Qix3QkFBd0I7QUFDNUMsZ0JBQThCLGlCQUFpQjtBQUMvQztBQUVDLElBOUJRO0FBQWEsUUFBckIsS0FBSyxFQUFFO0FBQUMseURBQWtDO0FBQzVDLElBQVU7QUFBYSxRQUFyQixLQUFLLEVBQUU7QUFBQywrREFBbUI7QUFDN0IsSUFBVTtBQUFhLFFBQXJCLEtBQUssRUFBRTtBQUFDLDhEQUFrQjtBQUM1QixJQUFtQjtBQUFhLFFBQTlCLEtBQUssQ0FBQyxTQUFTLENBQUM7QUFBQyxtRUFBdUI7QUFDMUMsSUFBb0I7QUFBYSxRQUEvQixLQUFLLENBQUMsVUFBVSxDQUFDO0FBQUMsZ0VBQWlCO0FBQ3JDLElBQ0M7QUFBYSxRQURaLFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxDQUFDO0FBQzFELG1FQUFtQztJQVB0Qix1QkFBdUIsd0JBTm5DLFNBQVMsQ0FBQyxjQUNULFFBQVEsRUFBRSxrQkFBa0IsY0FDNUIsUUFBUSxFQUFFLFFBQVEsY0FFbEIsYUFBYSxFQUFFLGlCQUFpQixDQUFDLElBQUksdUJBRDVCLE1BQU0sV0FFaEIsQ0FBQyxRQUNXLHVCQUF1QixDQWdNbkM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFDRDtBQUFDLElBREQsOEJBQUM7QUFDQSxDQURBLEFBaE1ELElBZ01DO0FBQ0QsU0FqTWEsdUJBQXVCO0FBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIE9uSW5pdCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQWZ0ZXJWaWV3Q2hlY2tlZCxcbiAgT25EZXN0cm95LFxuICBWaWV3RW5jYXBzdWxhdGlvbixcbiAgSW5wdXQsXG4gIFZpZXdDaGlsZCxcbiAgQ29tcG9uZW50UmVmLFxuICBUZW1wbGF0ZVJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBDaGFuZ2VEZXRlY3RvclJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBCbG9ja1VJSW5zdGFuY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvYmxvY2stdWktaW5zdGFuY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBCbG9ja1VJRXZlbnQgfSBmcm9tICcuLi8uLi9tb2RlbHMvYmxvY2stdWktZXZlbnQubW9kZWwnO1xuaW1wb3J0IHsgQmxvY2tVSUFjdGlvbnMgfSBmcm9tICcuLi8uLi9jb25zdGFudHMvYmxvY2stdWktYWN0aW9ucy5jb25zdGFudCc7XG5pbXBvcnQgeyBCbG9ja1VJRGVmYXVsdE5hbWUgfSBmcm9tICcuLi8uLi9jb25zdGFudHMvYmxvY2stdWktZGVmYXVsdC1uYW1lLmNvbnN0YW50JztcbmltcG9ydCB7IHN0eWxlcyB9IGZyb20gJy4vYmxvY2stdWktY29udGVudC5jb21wb25lbnQuc3R5bGUnO1xuaW1wb3J0IHsgdGVtcGxhdGUgfSBmcm9tICcuL2Jsb2NrLXVpLWNvbnRlbnQuY29tcG9uZW50LnRlbXBsYXRlJztcbmltcG9ydCB7IEJsb2NrVUlTZXR0aW5ncyB9IGZyb20gJy4uLy4uL21vZGVscy9ibG9jay11aS1zZXR0aW5ncy5tb2RlbCc7XG5cbmV4cG9ydCB0eXBlIEJsb2NrU3RhdGUgPSB7XG4gIHN0YXJ0VGltZW91dHM6IEFycmF5PGFueT47XG4gIHN0b3BUaW1lb3V0czogQXJyYXk8YW55PjtcbiAgdXBkYXRlVGltZW91dHM6IEFycmF5PGFueT47XG4gIGJsb2NrQ291bnQ6IG51bWJlcjtcbiAgc3RhcnRDYWxsQ291bnQ6IG51bWJlcjtcbiAgc3RvcENhbGxDb3VudDogbnVtYmVyO1xufTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYmxvY2stdWktY29udGVudCcsXG4gIHRlbXBsYXRlOiB0ZW1wbGF0ZSxcbiAgc3R5bGVzOiBbc3R5bGVzXSwgLy8gVE9ETzogRmluZCBob3cgdG8gYnVuZGxlIHN0eWxlcyBmb3IgbnBtXG4gIGVuY2Fwc3VsYXRpb246IFZpZXdFbmNhcHN1bGF0aW9uLk5vbmVcbn0pXG5leHBvcnQgY2xhc3MgQmxvY2tVSUNvbnRlbnRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIEFmdGVyVmlld0NoZWNrZWQsIE9uRGVzdHJveSB7XG4gIEBJbnB1dCgpIG5hbWU6IHN0cmluZyA9IEJsb2NrVUlEZWZhdWx0TmFtZTtcbiAgQElucHV0KCkgZGVsYXlTdGFydDogbnVtYmVyO1xuICBASW5wdXQoKSBkZWxheVN0b3A6IG51bWJlcjtcbiAgQElucHV0KCdtZXNzYWdlJykgZGVmYXVsdE1lc3NhZ2U6IHN0cmluZztcbiAgQElucHV0KCd0ZW1wbGF0ZScpIHRlbXBsYXRlQ21wOiBhbnk7XG4gIEBWaWV3Q2hpbGQoJ3RlbXBsYXRlT3V0bGV0JywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmIH0pXG4gIHRlbXBsYXRlT3V0bGV0OiBWaWV3Q29udGFpbmVyUmVmO1xuXG4gIGRlZmF1bHRCbG9ja1N0YXRlOiBCbG9ja1N0YXRlID0ge1xuICAgIHN0YXJ0VGltZW91dHM6IFtdLFxuICAgIHN0b3BUaW1lb3V0czogW10sXG4gICAgdXBkYXRlVGltZW91dHM6IFtdLFxuICAgIGJsb2NrQ291bnQ6IDAsXG4gICAgc3RhcnRDYWxsQ291bnQ6IDAsXG4gICAgc3RvcENhbGxDb3VudDogMFxuICB9O1xuICBzdGF0ZTogQmxvY2tTdGF0ZSA9IHsgLi4udGhpcy5kZWZhdWx0QmxvY2tTdGF0ZSB9O1xuICBjbGFzc05hbWU6IHN0cmluZztcbiAgdGVtcGxhdGVDb21wUmVmOiBDb21wb25lbnRSZWY8eyBtZXNzYWdlPzogYW55IH0+IHwgVGVtcGxhdGVSZWY8e30+O1xuICBtZXNzYWdlOiBhbnk7XG5cbiAgcHJpdmF0ZSBibG9ja1VJU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgc2V0dGluZ3M6IEJsb2NrVUlTZXR0aW5ncztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGJsb2NrVUk6IEJsb2NrVUlJbnN0YW5jZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0aW9uUmVmOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc2V0dGluZ3MgPSB0aGlzLmJsb2NrVUkuZ2V0U2V0dGluZ3MoKTtcbiAgICB0aGlzLmJsb2NrVUlTdWJzY3JpcHRpb24gPSB0aGlzLnN1YnNjcmliZVRvQmxvY2tVSSh0aGlzLmJsb2NrVUkub2JzZXJ2ZSgpKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLnRlbXBsYXRlQ21wKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMudGVtcGxhdGVDbXAgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZikge1xuICAgICAgICB0aGlzLnRlbXBsYXRlT3V0bGV0LmNyZWF0ZUVtYmVkZGVkVmlldyh0aGlzLnRlbXBsYXRlQ21wKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlQ29tcCA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGhpcy50ZW1wbGF0ZUNtcCk7XG4gICAgICAgIHRoaXMudGVtcGxhdGVDb21wUmVmID0gdGhpcy50ZW1wbGF0ZU91dGxldC5jcmVhdGVDb21wb25lbnQodGVtcGxhdGVDb21wKTtcbiAgICAgICAgdGhpcy51cGRhdGVCbG9ja1RlbXBsYXRlKHRoaXMubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25nLWJsb2NrLXVpOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIHN1YnNjcmliZVRvQmxvY2tVSShibG9ja1VJJDogT2JzZXJ2YWJsZTxhbnk+KTogU3Vic2NyaXB0aW9uIHtcbiAgICByZXR1cm4gYmxvY2tVSSQuc3Vic2NyaWJlKGV2ZW50ID0+IHRoaXMub25EaXNwYXRjaGVkRXZlbnQoZXZlbnQpKTtcbiAgfVxuXG4gIHByaXZhdGUgb25EaXNwYXRjaGVkRXZlbnQoZXZlbnQ6IEJsb2NrVUlFdmVudCkge1xuICAgIHN3aXRjaCAoZXZlbnQuYWN0aW9uKSB7XG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlNUQVJUOlxuICAgICAgICB0aGlzLm9uU3RhcnQoZXZlbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5TVE9QOlxuICAgICAgICB0aGlzLm9uU3RvcChldmVudCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlVQREFURTpcbiAgICAgICAgdGhpcy5vblVwZGF0ZShldmVudCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlJFU0VUOlxuICAgICAgICB0aGlzLm9uUmVzZXQoZXZlbnQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5SRVNFVF9HTE9CQUw6XG4gICAgICAgIHRoaXMucmVzZXRTdGF0ZSgpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBCbG9ja1VJQWN0aW9ucy5VTlNVQlNDUklCRTpcbiAgICAgICAgdGhpcy5vblN0b3AoZXZlbnQpO1xuICAgICAgICB0aGlzLm9uVW5zdWJzY3JpYmUoZXZlbnQubmFtZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25TdGFydCh7IG5hbWUsIG1lc3NhZ2UgfTogQmxvY2tVSUV2ZW50KSB7XG4gICAgaWYgKG5hbWUgPT09IHRoaXMubmFtZSkge1xuICAgICAgY29uc3QgZGVsYXkgPSB0aGlzLmRlbGF5U3RhcnQgfHwgdGhpcy5zZXR0aW5ncy5kZWxheVN0YXJ0IHx8IDA7XG5cbiAgICAgIHRoaXMuc3RhdGUuc3RhcnRDYWxsQ291bnQgKz0gMTtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnN0YXRlLmJsb2NrQ291bnQgKz0gMTtcbiAgICAgICAgdGhpcy5zaG93QmxvY2sobWVzc2FnZSk7XG4gICAgICAgIHRoaXMudXBkYXRlSW5zdGFuY2VCbG9ja0NvdW50KCk7XG4gICAgICB9LCBkZWxheSk7XG4gICAgICB0aGlzLnN0YXRlLnN0YXJ0VGltZW91dHMucHVzaChzdGFydFRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25TdG9wKHsgbmFtZSB9OiBCbG9ja1VJRXZlbnQpIHtcbiAgICBpZiAobmFtZSA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICBjb25zdCBzdG9wQ291bnQgPSB0aGlzLnN0YXRlLnN0b3BDYWxsQ291bnQgKyAxO1xuXG4gICAgICBpZiAodGhpcy5zdGF0ZS5zdGFydENhbGxDb3VudCAtIHN0b3BDb3VudCA+PSAwKSB7XG4gICAgICAgIGNvbnN0IGRlbGF5ID0gdGhpcy5kZWxheVN0b3AgfHwgdGhpcy5zZXR0aW5ncy5kZWxheVN0b3AgfHwgMDtcblxuICAgICAgICB0aGlzLnN0YXRlLnN0b3BDYWxsQ291bnQgPSBzdG9wQ291bnQ7XG4gICAgICAgIGNvbnN0IHN0b3BUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zdGF0ZS5ibG9ja0NvdW50IC09IDE7XG4gICAgICAgICAgdGhpcy51cGRhdGVJbnN0YW5jZUJsb2NrQ291bnQoKTtcbiAgICAgICAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgfSwgZGVsYXkpO1xuICAgICAgICB0aGlzLnN0YXRlLnN0b3BUaW1lb3V0cy5wdXNoKHN0b3BUaW1lb3V0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uVXBkYXRlKHsgbmFtZSwgbWVzc2FnZSB9OiBCbG9ja1VJRXZlbnQpIHtcbiAgICBpZiAobmFtZSA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICBjb25zdCBkZWxheSA9IHRoaXMuZGVsYXlTdGFydCB8fCB0aGlzLnNldHRpbmdzLmRlbGF5U3RhcnQgfHwgMDtcblxuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuc3RhdGUudXBkYXRlVGltZW91dHNbMF0pO1xuICAgICAgY29uc3QgdXBkYXRlVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZU1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICB9LCBkZWxheSk7XG4gICAgICB0aGlzLnN0YXRlLnVwZGF0ZVRpbWVvdXRzLnB1c2godXBkYXRlVGltZW91dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblJlc2V0KHsgbmFtZSB9OiBCbG9ja1VJRXZlbnQpIHtcbiAgICBpZiAobmFtZSA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICB0aGlzLnJlc2V0U3RhdGUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU1lc3NhZ2UobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhpcy5zaG93QmxvY2sobWVzc2FnZSk7XG4gIH1cblxuICBwcml2YXRlIHNob3dCbG9jayhtZXNzYWdlOiBhbnkpIHtcbiAgICB0aGlzLm1lc3NhZ2UgPSBtZXNzYWdlIHx8IHRoaXMuZGVmYXVsdE1lc3NhZ2UgfHwgdGhpcy5zZXR0aW5ncy5tZXNzYWdlO1xuICAgIHRoaXMudXBkYXRlQmxvY2tUZW1wbGF0ZSh0aGlzLm1lc3NhZ2UpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVCbG9ja1RlbXBsYXRlKG1zZzogYW55KTogdm9pZCB7XG4gICAgaWYgKHRoaXMudGVtcGxhdGVDb21wUmVmICYmIHRoaXMudGVtcGxhdGVDb21wUmVmIGluc3RhbmNlb2YgQ29tcG9uZW50UmVmKSB7XG4gICAgICB0aGlzLnRlbXBsYXRlQ29tcFJlZi5pbnN0YW5jZS5tZXNzYWdlID0gbXNnO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVzZXRTdGF0ZSgpIHtcbiAgICBbXG4gICAgICAuLi50aGlzLnN0YXRlLnN0YXJ0VGltZW91dHMsXG4gICAgICAuLi50aGlzLnN0YXRlLnN0b3BUaW1lb3V0cyxcbiAgICAgIC4uLnRoaXMuc3RhdGUudXBkYXRlVGltZW91dHNcbiAgICBdLmZvckVhY2goY2xlYXJUaW1lb3V0KTtcbiAgICB0aGlzLnN0YXRlID0geyAuLi50aGlzLmRlZmF1bHRCbG9ja1N0YXRlIH07XG4gICAgdGhpcy51cGRhdGVJbnN0YW5jZUJsb2NrQ291bnQoKTtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgb25VbnN1YnNjcmliZShuYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5ibG9ja1VJU3Vic2NyaXB0aW9uICYmIG5hbWUgPT09IHRoaXMubmFtZSkge1xuICAgICAgdGhpcy5ibG9ja1VJU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVJbnN0YW5jZUJsb2NrQ291bnQoKSB7XG4gICAgaWYgKHRoaXMuYmxvY2tVSS5ibG9ja1VJSW5zdGFuY2VzW3RoaXMubmFtZV0pIHtcbiAgICAgIGNvbnN0IHsgYmxvY2tDb3VudCB9ID0gdGhpcy5zdGF0ZTtcbiAgICAgIHRoaXMuYmxvY2tVSS5ibG9ja1VJSW5zdGFuY2VzW3RoaXMubmFtZV0uYmxvY2tDb3VudCA9IGJsb2NrQ291bnQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkZXRlY3RDaGFuZ2VzKCkge1xuICAgIGlmICghdGhpcy5jaGFuZ2VEZXRlY3Rpb25SZWZbJ2Rlc3Ryb3llZCddKSB7XG4gICAgICB0aGlzLmNoYW5nZURldGVjdGlvblJlZi5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5yZXNldFN0YXRlKCk7XG4gICAgdGhpcy5vblVuc3Vic2NyaWJlKHRoaXMubmFtZSk7XG4gICAgdGhpcy5ibG9ja1VJLmNsZWFySW5zdGFuY2UodGhpcy5uYW1lKTtcbiAgfVxufVxuIl19