import { __decorate } from "tslib";
import { Directive, Input, OnInit, OnDestroy, ComponentRef, ComponentFactoryResolver, ViewContainerRef, TemplateRef, Renderer2, EmbeddedViewRef } from '@angular/core';
import { BlockUIContentComponent } from '../components/block-ui-content/block-ui-content.component';
import { BlockUIInstanceService } from '../services/block-ui-instance.service';
import { BlockUIDefaultName } from '../constants/block-ui-default-name.constant';
import { BlockUIService } from '../services/block-ui.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../services/block-ui.service';
import * as ɵngcc2 from '../services/block-ui-instance.service';
let BlockUIDirective = class BlockUIDirective {
    constructor(blockUIService, blockUIInstanceService, viewRef, templateRef, renderer, componentFactoryResolver) {
        this.blockUIService = blockUIService;
        this.blockUIInstanceService = blockUIInstanceService;
        this.viewRef = viewRef;
        this.templateRef = templateRef;
        this.renderer = renderer;
        this.componentFactoryResolver = componentFactoryResolver;
    }
    set blockUI(name) { this.blockTarget = name; }
    ;
    set blockUIMessage(message) { this.message = message; }
    ;
    set blockUITemplate(template) { this.template = template; }
    ;
    set blockUIDelayStart(delayStart) {
        this.delayStart = delayStart ? Number(delayStart) : null;
    }
    ;
    set blockUIDelayStop(delayStop) {
        this.delayStop = delayStop ? Number(delayStop) : null;
    }
    ;
    ngOnInit() {
        try {
            this.viewRef.createEmbeddedView(this.templateRef);
            const parentElement = this.getParentElement();
            if (parentElement && !this.isComponentInTemplate(parentElement)) {
                this.renderer.addClass(parentElement, 'block-ui__element');
                this.blockUIComponentRef = this.createComponent();
                let blockUIContent = this.findContentNode(this.viewRef.element.nativeElement);
                if (blockUIContent) {
                    const settings = this.blockUIInstanceService.getSettings();
                    parentElement.appendChild(blockUIContent);
                    this.blockUIComponentRef.instance.className = 'block-ui-wrapper--element';
                    this.blockUIComponentRef.instance.name = this.blockTarget || BlockUIDefaultName;
                    if (this.message)
                        this.blockUIComponentRef.instance.defaultMessage = this.message;
                    if (this.delayStart)
                        this.blockUIComponentRef.instance.delayStart = this.delayStart;
                    if (this.delayStop)
                        this.blockUIComponentRef.instance.delayStop = this.delayStop;
                    if (this.template || settings.template)
                        this.blockUIComponentRef.instance.templateCmp = this.template || settings.template;
                }
            }
        }
        catch (error) {
            console.error('ng-block-ui:', error);
        }
    }
    isComponentInTemplate(element) {
        // Needed because of https://github.com/microsoft/TypeScript/issues/26235
        const targetElement = element || {};
        let { children } = targetElement;
        children = Array.from(children || []).reverse();
        return children.some((el) => el && el.localName === 'block-ui');
    }
    getParentElement() {
        const embeddedView = this.viewRef.get(0);
        return embeddedView.rootNodes[0];
    }
    // Needed for IE (#17)
    findContentNode(element) {
        const nextSibling = element.nextSibling || {};
        const previousSibling = element.previousSibling || {};
        return [
            nextSibling,
            nextSibling.nextSibling,
            previousSibling,
            previousSibling.previousSibling
        ].find((e) => e && e.localName === 'block-ui-content');
    }
    createComponent() {
        const resolvedBlockUIComponent = this.componentFactoryResolver.resolveComponentFactory(BlockUIContentComponent);
        return this.viewRef.createComponent(resolvedBlockUIComponent);
    }
    ngOnDestroy() {
        if (this.blockTarget) {
            this.blockUIService.reset(this.blockTarget);
        }
    }
};
BlockUIDirective.ɵfac = function BlockUIDirective_Factory(t) { return new (t || BlockUIDirective)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BlockUIService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.BlockUIInstanceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ViewContainerRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.TemplateRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.Renderer2), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver)); };
BlockUIDirective.ɵdir = ɵngcc0.ɵɵdefineDirective({ type: BlockUIDirective, selectors: [["", "blockUI", ""]], inputs: { blockUI: "blockUI", blockUIMessage: "blockUIMessage", blockUITemplate: "blockUITemplate", blockUIDelayStart: "blockUIDelayStart", blockUIDelayStop: "blockUIDelayStop" } });
BlockUIDirective.ctorParameters = () => [
    { type: BlockUIService },
    { type: BlockUIInstanceService },
    { type: ViewContainerRef },
    { type: TemplateRef },
    { type: Renderer2 },
    { type: ComponentFactoryResolver }
];
__decorate([
    Input()
], BlockUIDirective.prototype, "blockUI", null);
__decorate([
    Input()
], BlockUIDirective.prototype, "blockUIMessage", null);
__decorate([
    Input()
], BlockUIDirective.prototype, "blockUITemplate", null);
__decorate([
    Input()
], BlockUIDirective.prototype, "blockUIDelayStart", null);
__decorate([
    Input()
], BlockUIDirective.prototype, "blockUIDelayStop", null);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(BlockUIDirective, [{
        type: Directive,
        args: [{ selector: '[blockUI]' }]
    }], function () { return [{ type: ɵngcc1.BlockUIService }, { type: ɵngcc2.BlockUIInstanceService }, { type: ɵngcc0.ViewContainerRef }, { type: ɵngcc0.TemplateRef }, { type: ɵngcc0.Renderer2 }, { type: ɵngcc0.ComponentFactoryResolver }]; }, { blockUI: [{
            type: Input
        }], blockUIMessage: [{
            type: Input
        }], blockUITemplate: [{
            type: Input
        }], blockUIDelayStart: [{
            type: Input
        }], blockUIDelayStop: [{
            type: Input
        }] }); })();
export { BlockUIDirective };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWkuZGlyZWN0aXZlLmpzIiwic291cmNlcyI6WyJuZy1ibG9jay11aS9kaXJlY3RpdmVzL2Jsb2NrLXVpLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxZQUFZLEVBQ1osd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixXQUFXLEVBQ1gsU0FBUyxFQUNULGVBQWUsRUFDaEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFDcEcsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDL0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNkNBQTZDLENBQUM7QUFDakYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDhCQUE4QixDQUFDOzs7O0FBRzlELElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0FBQUcsSUF1QjlCLFlBQ1UsY0FBOEIsRUFDOUIsc0JBQThDLEVBQzlDLE9BQXlCLEVBQ3pCLFdBQTZCLEVBQzdCLFFBQW1CLEVBQ25CLHdCQUFrRDtBQUMzRCxRQU5TLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtBQUFDLFFBQy9CLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7QUFBQyxRQUMvQyxZQUFPLEdBQVAsT0FBTyxDQUFrQjtBQUFDLFFBQzFCLGdCQUFXLEdBQVgsV0FBVyxDQUFrQjtBQUFDLFFBQzlCLGFBQVEsR0FBUixRQUFRLENBQVc7QUFBQyxRQUNwQiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO0FBQzlELElBQU0sQ0FBQztBQUNQLElBdEJFLElBQUksT0FBTyxDQUFDLElBQVMsSUFBSSxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7QUFBQyxJQUFELENBQUM7QUFDdEQsSUFDRSxJQUFJLGNBQWMsQ0FB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d0JBQXdCLEdBQUcsSUFBSSxDQUFDLHdCQUF3QixDQUFDLHVCQUF1QixDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDcEgsUUFBSSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDbEUsSUFBRSxDQUFDO0FBQ0gsSUFDRSxXQUFXO0FBQ2IsUUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7QUFDMUIsWUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDbEQsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNILENBQUM7O21TQUFBO0FBQ0Q7QUFBMEMsWUEzRWQsY0FBYztBQUN4QyxZQUFrQyxzQkFBc0I7QUFDeEQsWUFBbUIsZ0JBQWdCO0FBQ25DLFlBQXVCLFdBQVc7QUFBSSxZQUNsQixTQUFTO0FBQzdCLFlBQW9DLHdCQUF3QjtBQUM1RDtBQXJCQTtBQUFhLElBRFosS0FBSyxFQUFFO0FBQ1YsK0NBQXFEO0FBRW5EO0FBQWEsSUFEWixLQUFLLEVBQUU7QUFDVixzREFBOEQ7QUFFNUQ7QUFBYSxJQURaLEtBQUssRUFBRTtBQUNWLHVEQUFrRTtBQUVoRTtBQUFhLElBRFosS0FBSyxFQUFFO0FBQ1YseURBRUc7QUFFRDtBQUFhLElBRFosS0FBSyxFQUFFO0FBQ1Ysd0RBRUc7QUFyQlUsZ0JBQWdCLG9CQUQ1QixTQUFTLENBQUMsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLENBQUMsSUFDeEIsZ0JBQWdCLENBa0c1Qjs7Ozs7Ozs7Ozs7OztvQkFDRDtBQUFDLFNBbkdZLGdCQUFnQjtBQUFJIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBJbnB1dCxcbiAgT25Jbml0LFxuICBPbkRlc3Ryb3ksXG4gIENvbXBvbmVudFJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBWaWV3Q29udGFpbmVyUmVmLFxuICBUZW1wbGF0ZVJlZixcbiAgUmVuZGVyZXIyLFxuICBFbWJlZGRlZFZpZXdSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCbG9ja1VJQ29udGVudENvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvYmxvY2stdWktY29udGVudC9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBCbG9ja1VJSW5zdGFuY2VTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYmxvY2stdWktaW5zdGFuY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBCbG9ja1VJRGVmYXVsdE5hbWUgfSBmcm9tICcuLi9jb25zdGFudHMvYmxvY2stdWktZGVmYXVsdC1uYW1lLmNvbnN0YW50JztcbmltcG9ydCB7IEJsb2NrVUlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvYmxvY2stdWkuc2VydmljZSc7XG5cbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tibG9ja1VJXScgfSlcbmV4cG9ydCBjbGFzcyBCbG9ja1VJRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIGJsb2NrVUlDb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxCbG9ja1VJQ29udGVudENvbXBvbmVudD47XG4gIGJsb2NrVGFyZ2V0OiBzdHJpbmc7XG4gIG1lc3NhZ2U6IGFueTtcbiAgdGVtcGxhdGU6IGFueTtcbiAgZGVsYXlTdGFydDogYW55O1xuICBkZWxheVN0b3A6IGFueTtcblxuICBASW5wdXQoKVxuICBzZXQgYmxvY2tVSShuYW1lOiBhbnkpIHsgdGhpcy5ibG9ja1RhcmdldCA9IG5hbWU7IH07XG4gIEBJbnB1dCgpXG4gIHNldCBibG9ja1VJTWVzc2FnZShtZXNzYWdlOiBhbnkpIHsgdGhpcy5tZXNzYWdlID0gbWVzc2FnZTsgfTtcbiAgQElucHV0KClcbiAgc2V0IGJsb2NrVUlUZW1wbGF0ZSh0ZW1wbGF0ZTogYW55KSB7IHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsgfTtcbiAgQElucHV0KClcbiAgc2V0IGJsb2NrVUlEZWxheVN0YXJ0KGRlbGF5U3RhcnQ6IGFueSkge1xuICAgIHRoaXMuZGVsYXlTdGFydCA9IGRlbGF5U3RhcnQgPyBOdW1iZXIoZGVsYXlTdGFydCkgOiBudWxsO1xuICB9O1xuICBASW5wdXQoKVxuICBzZXQgYmxvY2tVSURlbGF5U3RvcChkZWxheVN0b3A6IGFueSkge1xuICAgIHRoaXMuZGVsYXlTdG9wID0gZGVsYXlTdG9wID8gTnVtYmVyKGRlbGF5U3RvcCkgOiBudWxsO1xuICB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYmxvY2tVSVNlcnZpY2U6IEJsb2NrVUlTZXJ2aWNlLFxuICAgIHByaXZhdGUgYmxvY2tVSUluc3RhbmNlU2VydmljZTogQmxvY2tVSUluc3RhbmNlU2VydmljZSxcbiAgICBwcml2YXRlIHZpZXdSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgcHJpdmF0ZSB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8YW55PixcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlclxuICApIHsgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnZpZXdSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMudGVtcGxhdGVSZWYpO1xuICAgICAgY29uc3QgcGFyZW50RWxlbWVudCA9IHRoaXMuZ2V0UGFyZW50RWxlbWVudCgpO1xuXG4gICAgICBpZiAocGFyZW50RWxlbWVudCAmJiAhdGhpcy5pc0NvbXBvbmVudEluVGVtcGxhdGUocGFyZW50RWxlbWVudCkpIHtcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyhwYXJlbnRFbGVtZW50LCAnYmxvY2stdWlfX2VsZW1lbnQnKTtcbiAgICAgICAgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmID0gdGhpcy5jcmVhdGVDb21wb25lbnQoKTtcbiAgICAgICAgbGV0IGJsb2NrVUlDb250ZW50ID0gdGhpcy5maW5kQ29udGVudE5vZGUodGhpcy52aWV3UmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG5cbiAgICAgICAgaWYgKGJsb2NrVUlDb250ZW50KSB7XG4gICAgICAgICAgY29uc3Qgc2V0dGluZ3MgPSB0aGlzLmJsb2NrVUlJbnN0YW5jZVNlcnZpY2UuZ2V0U2V0dGluZ3MoKTtcblxuICAgICAgICAgIHBhcmVudEVsZW1lbnQuYXBwZW5kQ2hpbGQoYmxvY2tVSUNvbnRlbnQpO1xuICAgICAgICAgIHRoaXMuYmxvY2tVSUNvbXBvbmVudFJlZi5pbnN0YW5jZS5jbGFzc05hbWUgPSAnYmxvY2stdWktd3JhcHBlci0tZWxlbWVudCc7XG4gICAgICAgICAgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmLmluc3RhbmNlLm5hbWUgPSB0aGlzLmJsb2NrVGFyZ2V0IHx8IEJsb2NrVUlEZWZhdWx0TmFtZTtcbiAgICAgICAgICBpZiAodGhpcy5tZXNzYWdlKSB0aGlzLmJsb2NrVUlDb21wb25lbnRSZWYuaW5zdGFuY2UuZGVmYXVsdE1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2U7XG4gICAgICAgICAgaWYgKHRoaXMuZGVsYXlTdGFydCkgdGhpcy5ibG9ja1VJQ29tcG9uZW50UmVmLmluc3RhbmNlLmRlbGF5U3RhcnQgPSB0aGlzLmRlbGF5U3RhcnQ7XG4gICAgICAgICAgaWYgKHRoaXMuZGVsYXlTdG9wKSB0aGlzLmJsb2NrVUlDb21wb25lbnRSZWYuaW5zdGFuY2UuZGVsYXlTdG9wID0gdGhpcy5kZWxheVN0b3A7XG4gICAgICAgICAgaWYgKHRoaXMudGVtcGxhdGUgfHwgc2V0dGluZ3MudGVtcGxhdGUpXG4gICAgICAgICAgICB0aGlzLmJsb2NrVUlDb21wb25lbnRSZWYuaW5zdGFuY2UudGVtcGxhdGVDbXAgPSB0aGlzLnRlbXBsYXRlIHx8IHNldHRpbmdzLnRlbXBsYXRlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ25nLWJsb2NrLXVpOicsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzQ29tcG9uZW50SW5UZW1wbGF0ZShlbGVtZW50OiBhbnkpOiBib29sZWFuIHtcbiAgICAvLyBOZWVkZWQgYmVjYXVzZSBvZiBodHRwczovL2dpdGh1Yi5jb20vbWljcm9zb2Z0L1R5cGVTY3JpcHQvaXNzdWVzLzI2MjM1XG4gICAgY29uc3QgdGFyZ2V0RWxlbWVudCA9IGVsZW1lbnQgfHwge307XG4gICAgbGV0IHsgY2hpbGRyZW4gfSA9IHRhcmdldEVsZW1lbnQ7XG4gICAgY2hpbGRyZW4gPSBBcnJheS5mcm9tKGNoaWxkcmVuIHx8IFtdKS5yZXZlcnNlKCk7XG4gICAgcmV0dXJuIGNoaWxkcmVuLnNvbWUoKGVsOiBhbnkpID0+IGVsICYmIGVsLmxvY2FsTmFtZSA9PT0gJ2Jsb2NrLXVpJyk7XG4gIH1cblxuICBwcml2YXRlIGdldFBhcmVudEVsZW1lbnQoKTogRWxlbWVudCB7XG4gICAgY29uc3QgZW1iZWRkZWRWaWV3ID0gdGhpcy52aWV3UmVmLmdldCgwKSBhcyBFbWJlZGRlZFZpZXdSZWY8YW55PjtcblxuICAgIHJldHVybiBlbWJlZGRlZFZpZXcucm9vdE5vZGVzWzBdO1xuXG4gIH1cblxuICAvLyBOZWVkZWQgZm9yIElFICgjMTcpXG4gIHByaXZhdGUgZmluZENvbnRlbnROb2RlKGVsZW1lbnQ6IGFueSkge1xuICAgIGNvbnN0IG5leHRTaWJsaW5nID0gZWxlbWVudC5uZXh0U2libGluZyB8fCB7fTtcbiAgICBjb25zdCBwcmV2aW91c1NpYmxpbmcgPSBlbGVtZW50LnByZXZpb3VzU2libGluZyB8fCB7fTtcblxuICAgIHJldHVybiBbXG4gICAgICBuZXh0U2libGluZyxcbiAgICAgIG5leHRTaWJsaW5nLm5leHRTaWJsaW5nLFxuICAgICAgcHJldmlvdXNTaWJsaW5nLFxuICAgICAgcHJldmlvdXNTaWJsaW5nLnByZXZpb3VzU2libGluZ1xuICAgIF0uZmluZCgoZSkgPT4gZSAmJiBlLmxvY2FsTmFtZSA9PT0gJ2Jsb2NrLXVpLWNvbnRlbnQnKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ29tcG9uZW50KCkge1xuICAgIGNvbnN0IHJlc29sdmVkQmxvY2tVSUNvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KEJsb2NrVUlDb250ZW50Q29tcG9uZW50KTtcbiAgICByZXR1cm4gdGhpcy52aWV3UmVmLmNyZWF0ZUNvbXBvbmVudChyZXNvbHZlZEJsb2NrVUlDb21wb25lbnQpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuYmxvY2tUYXJnZXQpIHtcbiAgICAgIHRoaXMuYmxvY2tVSVNlcnZpY2UucmVzZXQodGhpcy5ibG9ja1RhcmdldCk7XG4gICAgfVxuICB9XG59XG4iXX0=