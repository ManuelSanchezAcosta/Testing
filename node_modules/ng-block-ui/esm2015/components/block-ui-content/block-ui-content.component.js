import { __decorate } from "tslib";
import { Component, OnInit, AfterViewInit, AfterViewChecked, OnDestroy, ViewEncapsulation, Input, ViewChild, ComponentRef, TemplateRef, ComponentFactoryResolver, ViewContainerRef, ChangeDetectorRef } from '@angular/core';
import { BlockUIInstanceService } from '../../services/block-ui-instance.service';
import { BlockUIActions } from '../../constants/block-ui-actions.constant';
import { BlockUIDefaultName } from '../../constants/block-ui-default-name.constant';
import { styles } from './block-ui-content.component.style';
import { template } from './block-ui-content.component.template';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../services/block-ui-instance.service';
import * as ɵngcc2 from '@angular/common';

const _c0 = ["templateOutlet"];
function BlockUIContentComponent_div_1_div_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 6);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ctx_r2.message || ctx_r2.defaultMessage, " ");
} }
function BlockUIContentComponent_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 3);
    ɵngcc0.ɵɵelement(1, "div", 4);
    ɵngcc0.ɵɵtemplate(2, BlockUIContentComponent_div_1_div_2_Template, 2, 1, "div", 5);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.message || ctx_r0.defaultMessage);
} }
function BlockUIContentComponent_2_ng_template_0_Template(rf, ctx) { }
function BlockUIContentComponent_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵtemplate(0, BlockUIContentComponent_2_ng_template_0_Template, 0, 0, "ng-template", null, 7, ɵngcc0.ɵɵtemplateRefExtractor);
} }
const _c1 = function (a0) { return { "active": a0 }; };
let BlockUIContentComponent = class BlockUIContentComponent {
    constructor(blockUI, resolver, changeDetectionRef) {
        this.blockUI = blockUI;
        this.resolver = resolver;
        this.changeDetectionRef = changeDetectionRef;
        this.name = BlockUIDefaultName;
        this.defaultBlockState = {
            startTimeouts: [],
            stopTimeouts: [],
            updateTimeouts: [],
            blockCount: 0,
            startCallCount: 0,
            stopCallCount: 0
        };
        this.state = Object.assign({}, this.defaultBlockState);
    }
    ngOnInit() {
        this.settings = this.blockUI.getSettings();
        this.blockUISubscription = this.subscribeToBlockUI(this.blockUI.observe());
    }
    ngAfterViewInit() {
        try {
            if (!this.templateCmp) {
                return false;
            }
            if (this.templateCmp instanceof TemplateRef) {
                this.templateOutlet.createEmbeddedView(this.templateCmp);
            }
            else {
                const templateComp = this.resolver.resolveComponentFactory(this.templateCmp);
                this.templateCompRef = this.templateOutlet.createComponent(templateComp);
                this.updateBlockTemplate(this.message);
            }
        }
        catch (error) {
            console.error('ng-block-ui:', error);
        }
    }
    ngAfterViewChecked() {
        this.detectChanges();
    }
    subscribeToBlockUI(blockUI$) {
        return blockUI$.subscribe(event => this.onDispatchedEvent(event));
    }
    onDispatchedEvent(event) {
        switch (event.action) {
            case BlockUIActions.START:
                this.onStart(event);
                break;
            case BlockUIActions.STOP:
                this.onStop(event);
                break;
            case BlockUIActions.UPDATE:
                this.onUpdate(event);
                break;
            case BlockUIActions.RESET:
                this.onReset(event);
                break;
            case BlockUIActions.RESET_GLOBAL:
                this.resetState();
                break;
            case BlockUIActions.UNSUBSCRIBE:
                this.onStop(event);
                this.onUnsubscribe(event.name);
                break;
        }
    }
    onStart({ name, message }) {
        if (name === this.name) {
            const delay = this.delayStart || this.settings.delayStart || 0;
            this.state.startCallCount += 1;
            const startTimeout = setTimeout(() => {
                this.state.blockCount += 1;
                this.showBlock(message);
                this.updateInstanceBlockCount();
            }, delay);
            this.state.startTimeouts.push(startTimeout);
        }
    }
    onStop({ name }) {
        if (name === this.name) {
            const stopCount = this.state.stopCallCount + 1;
            if (this.state.startCallCount - stopCount >= 0) {
                const delay = this.delayStop || this.settings.delayStop || 0;
                this.state.stopCallCount = stopCount;
                const stopTimeout = setTimeout(() => {
                    this.state.blockCount -= 1;
                    this.updateInstanceBlockCount();
                    this.detectChanges();
                }, delay);
                this.state.stopTimeouts.push(stopTimeout);
            }
        }
    }
    onUpdate({ name, message }) {
        if (name === this.name) {
            const delay = this.delayStart || this.settings.delayStart || 0;
            clearTimeout(this.state.updateTimeouts[0]);
            const updateTimeout = setTimeout(() => {
                this.updateMessage(message);
            }, delay);
            this.state.updateTimeouts.push(updateTimeout);
        }
    }
    onReset({ name }) {
        if (name === this.name) {
            this.resetState();
        }
    }
    updateMessage(message) {
        this.showBlock(message);
    }
    showBlock(message) {
        this.message = message || this.defaultMessage || this.settings.message;
        this.updateBlockTemplate(this.message);
        this.detectChanges();
    }
    updateBlockTemplate(msg) {
        if (this.templateCompRef && this.templateCompRef instanceof ComponentRef) {
            this.templateCompRef.instance.message = msg;
        }
    }
    resetState() {
        [
            ...this.state.startTimeouts,
            ...this.state.stopTimeouts,
            ...this.state.updateTimeouts
        ].forEach(clearTimeout);
        this.state = Object.assign({}, this.defaultBlockState);
        this.updateInstanceBlockCount();
        this.detectChanges();
    }
    onUnsubscribe(name) {
        if (this.blockUISubscription && name === this.name) {
            this.blockUISubscription.unsubscribe();
        }
    }
    updateInstanceBlockCount() {
        if (this.blockUI.blockUIInstances[this.name]) {
            const { blockCount } = this.state;
            this.blockUI.blockUIInstances[this.name].blockCount = blockCount;
        }
    }
    detectChanges() {
        if (!this.changeDetectionRef['destroyed']) {
            this.changeDetectionRef.detectChanges();
        }
    }
    ngOnDestroy() {
        this.resetState();
        this.onUnsubscribe(this.name);
        this.blockUI.clearInstance(this.name);
    }
};
BlockUIContentComponent.ɵfac = function BlockUIContentComponent_Factory(t) { return new (t || BlockUIContentComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BlockUIInstanceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef)); };
BlockUIContentComponent.ɵcmp = ɵngcc0.ɵɵdefineComponent({ type: BlockUIContentComponent, selectors: [["block-ui-content"]], viewQuery: function BlockUIContentComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(_c0, 1, ViewContainerRef);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.templateOutlet = _t.first);
    } }, inputs: { name: "name", delayStart: "delayStart", delayStop: "delayStop", defaultMessage: ["message", "defaultMessage"], templateCmp: ["template", "templateCmp"] }, decls: 3, vars: 9, consts: [[3, "ngClass"], ["class", "block-ui-spinner", 4, "ngIf"], [4, "ngIf"], [1, "block-ui-spinner"], [1, "loader"], ["class", "message", 4, "ngIf"], [1, "message"], ["templateOutlet", ""]], template: function BlockUIContentComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵtemplate(1, BlockUIContentComponent_div_1_Template, 3, 1, "div", 1);
        ɵngcc0.ɵɵtemplate(2, BlockUIContentComponent_2_Template, 2, 0, undefined, 2);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵclassMapInterpolate2("block-ui-wrapper ", ctx.name, " ", ctx.className, "");
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(7, _c1, ctx.state.blockCount > 0));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.templateCmp);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.templateCmp);
    } }, directives: [ɵngcc2.NgClass, ɵngcc2.NgIf], styles: ["\n.block-ui-wrapper {\n  display: none;\n  position: fixed;\n  height: 100%;\n  width: 100%;\n  top: 0;\n  left: 0;\n  background: rgba(0, 0, 0, 0.70);\n  z-index: 30000;\n  cursor: wait;\n}\n\n.block-ui-wrapper.block-ui-wrapper--element {\n  position: absolute;\n}\n\n.block-ui-wrapper.active {\n  display: block;\n}\n\n.block-ui-wrapper.block-ui-main {\n  position: fixed;\n}\n\n.block-ui-spinner,\n.block-ui-template {\n  position: absolute;\n  top: 40%;\n  margin: 0 auto;\n  left: 0;\n  right: 0;\n  transform: translateY(-50%);\n}\n\n.block-ui-spinner > .message {\n  font-size: 1.3em;\n  text-align: center;\n  color: #fff;\n}\n\n.block-ui__element {\n  position: relative;\n}\n\n.loader,\n.loader:after {\n  border-radius: 50%;\n  width: 10em;\n  height: 10em;\n}\n.loader {\n  margin: 7px auto;\n  font-size: 5px;\n  position: relative;\n  text-indent: -9999em;\n  border-top: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-right: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-bottom: 1.1em solid rgba(255, 255, 255, 0.2);\n  border-left: 1.1em solid #ffffff;\n  -webkit-transform: translateZ(0);\n  -ms-transform: translateZ(0);\n  transform: translateZ(0);\n  -webkit-animation: load8 1.1s infinite linear;\n  animation: load8 1.1s infinite linear;\n}\n\n@-webkit-keyframes load8 {\n  0% {\n    -webkit-transform: rotate(0deg);\n    transform: rotate(0deg);\n  }\n  100% {\n    -webkit-transform: rotate(360deg);\n    transform: rotate(360deg);\n  }\n}\n\n@keyframes load8 {\n  0% {\n    -webkit-transform: rotate(0deg);\n    transform: rotate(0deg);\n  }\n  100% {\n    -webkit-transform: rotate(360deg);\n    transform: rotate(360deg);\n  }\n}\n"], encapsulation: 2 });
BlockUIContentComponent.ctorParameters = () => [
    { type: BlockUIInstanceService },
    { type: ComponentFactoryResolver },
    { type: ChangeDetectorRef }
];
__decorate([
    Input()
], BlockUIContentComponent.prototype, "name", void 0);
__decorate([
    Input()
], BlockUIContentComponent.prototype, "delayStart", void 0);
__decorate([
    Input()
], BlockUIContentComponent.prototype, "delayStop", void 0);
__decorate([
    Input('message')
], BlockUIContentComponent.prototype, "defaultMessage", void 0);
__decorate([
    Input('template')
], BlockUIContentComponent.prototype, "templateCmp", void 0);
__decorate([
    ViewChild('templateOutlet', { read: ViewContainerRef })
], BlockUIContentComponent.prototype, "templateOutlet", void 0);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(BlockUIContentComponent, [{
        type: Component,
        args: [{
                selector: 'block-ui-content',
                template: template,
                encapsulation: ViewEncapsulation.None,
                styles: [styles]
            }]
    }], function () { return [{ type: ɵngcc1.BlockUIInstanceService }, { type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc0.ChangeDetectorRef }]; }, { name: [{
            type: Input
        }], delayStart: [{
            type: Input
        }], delayStop: [{
            type: Input
        }], defaultMessage: [{
            type: Input,
            args: ['message']
        }], templateCmp: [{
            type: Input,
            args: ['template']
        }], templateOutlet: [{
            type: ViewChild,
            args: ['templateOutlet', { read: ViewContainerRef }]
        }] }); })();
export { BlockUIContentComponent };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmxvY2stdWktY29udGVudC5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIm5nLWJsb2NrLXVpL2NvbXBvbmVudHMvYmxvY2stdWktY29udGVudC9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sYUFBYSxFQUNiLGdCQUFnQixFQUNoQixTQUFTLEVBQ1QsaUJBQWlCLEVBQ2pCLEtBQUssRUFDTCxTQUFTLEVBQ1QsWUFBWSxFQUNaLFdBQVcsRUFDWCx3QkFBd0IsRUFDeEIsZ0JBQWdCLEVBQ2hCLGlCQUFpQixFQUNsQixNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVsRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDcEYsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLG9DQUFvQyxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBa0JqRSxJQUFhLHVCQUF1QixHQUFwQyxNQUFhLHVCQUF1QjtBQUFHLElBeUJyQyxZQUNVLE9BQStCLEVBQy9CLFFBQWtDLEVBQ2xDLGtCQUFxQztBQUM5QyxRQUhTLFlBQU8sR0FBUCxPQUFPLENBQXdCO0FBQUMsUUFDaEMsYUFBUSxHQUFSLFFBQVEsQ0FBMEI7QUFBQyxRQUNuQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW1CO0FBQ2pELFFBNUJXLFNBQUksR0FBVyxrQkFBa0IsQ0FBQztBQUM3QyxRQU9FLHNCQUFpQixHQUFlO0FBQ2xDLFlBQUksYUFBYSxFQUFFLEVBQUU7QUFDckIsWUFBSSxZQUFZLEVBQUUsRUFBRTtBQUNwQixZQUFJLGNBQWMsRUFBRSxF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QUFBQyxxREFBa0M7QUFDbEM7QUFBYSxJQUFyQixLQUFLLEVBQUU7QUFBQywyREFBbUI7QUFDbkI7QUFBYSxJQUFyQixLQUFLLEVBQUU7QUFBQywwREFBa0I7QUFDVDtBQUFhLElBQTlCLEtBQUssQ0FBQyxTQUFTLENBQUM7QUFBQywrREFBdUI7QUFDdEI7QUFBYSxJQUEvQixLQUFLLENBQUMsVUFBVSxDQUFDO0FBQUMsNERBQWlCO0FBRXBDO0FBQWEsSUFEWixTQUFTLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQztBQUMxRCwrREFBbUM7QUFQdEIsdUJBQXVCLG9CQU5uQyxTQUFTLENBQUMsVUFDVCxRQUFRLEVBQUUsa0JBQWtCLFVBQzVCLFFBQVEsRUFBRTtBQUFRLFVBRWxCLGFBQWE7QUFBRTtBQUFpQixDQUFDLElBQUksbUJBRDVCLE1BQU0sT0FFaEIsQ0FBQyxJQUNXO21CQUF1QixDQWdNbkM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7b0JBQ0Q7QUFBQyxTQWpNWSx1QkFBdUI7QUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgT25Jbml0LFxuICBBZnRlclZpZXdJbml0LFxuICBBZnRlclZpZXdDaGVja2VkLFxuICBPbkRlc3Ryb3ksXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxuICBJbnB1dCxcbiAgVmlld0NoaWxkLFxuICBDb21wb25lbnRSZWYsXG4gIFRlbXBsYXRlUmVmLFxuICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gIFZpZXdDb250YWluZXJSZWYsXG4gIENoYW5nZURldGVjdG9yUmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7IEJsb2NrVUlJbnN0YW5jZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9ibG9jay11aS1pbnN0YW5jZS5zZXJ2aWNlJztcbmltcG9ydCB7IEJsb2NrVUlFdmVudCB9IGZyb20gJy4uLy4uL21vZGVscy9ibG9jay11aS1ldmVudC5tb2RlbCc7XG5pbXBvcnQgeyBCbG9ja1VJQWN0aW9ucyB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy9ibG9jay11aS1hY3Rpb25zLmNvbnN0YW50JztcbmltcG9ydCB7IEJsb2NrVUlEZWZhdWx0TmFtZSB9IGZyb20gJy4uLy4uL2NvbnN0YW50cy9ibG9jay11aS1kZWZhdWx0LW5hbWUuY29uc3RhbnQnO1xuaW1wb3J0IHsgc3R5bGVzIH0gZnJvbSAnLi9ibG9jay11aS1jb250ZW50LmNvbXBvbmVudC5zdHlsZSc7XG5pbXBvcnQgeyB0ZW1wbGF0ZSB9IGZyb20gJy4vYmxvY2stdWktY29udGVudC5jb21wb25lbnQudGVtcGxhdGUnO1xuaW1wb3J0IHsgQmxvY2tVSVNldHRpbmdzIH0gZnJvbSAnLi4vLi4vbW9kZWxzL2Jsb2NrLXVpLXNldHRpbmdzLm1vZGVsJztcblxuZXhwb3J0IHR5cGUgQmxvY2tTdGF0ZSA9IHtcbiAgc3RhcnRUaW1lb3V0czogQXJyYXk8YW55PjtcbiAgc3RvcFRpbWVvdXRzOiBBcnJheTxhbnk+O1xuICB1cGRhdGVUaW1lb3V0czogQXJyYXk8YW55PjtcbiAgYmxvY2tDb3VudDogbnVtYmVyO1xuICBzdGFydENhbGxDb3VudDogbnVtYmVyO1xuICBzdG9wQ2FsbENvdW50OiBudW1iZXI7XG59O1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdibG9jay11aS1jb250ZW50JyxcbiAgdGVtcGxhdGU6IHRlbXBsYXRlLFxuICBzdHlsZXM6IFtzdHlsZXNdLCAvLyBUT0RPOiBGaW5kIGhvdyB0byBidW5kbGUgc3R5bGVzIGZvciBucG1cbiAgZW5jYXBzdWxhdGlvbjogVmlld0VuY2Fwc3VsYXRpb24uTm9uZVxufSlcbmV4cG9ydCBjbGFzcyBCbG9ja1VJQ29udGVudENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcbiAgQElucHV0KCkgbmFtZTogc3RyaW5nID0gQmxvY2tVSURlZmF1bHROYW1lO1xuICBASW5wdXQoKSBkZWxheVN0YXJ0OiBudW1iZXI7XG4gIEBJbnB1dCgpIGRlbGF5U3RvcDogbnVtYmVyO1xuICBASW5wdXQoJ21lc3NhZ2UnKSBkZWZhdWx0TWVzc2FnZTogc3RyaW5nO1xuICBASW5wdXQoJ3RlbXBsYXRlJykgdGVtcGxhdGVDbXA6IGFueTtcbiAgQFZpZXdDaGlsZCgndGVtcGxhdGVPdXRsZXQnLCB7IHJlYWQ6IFZpZXdDb250YWluZXJSZWYgfSlcbiAgdGVtcGxhdGVPdXRsZXQ6IFZpZXdDb250YWluZXJSZWY7XG5cbiAgZGVmYXVsdEJsb2NrU3RhdGU6IEJsb2NrU3RhdGUgPSB7XG4gICAgc3RhcnRUaW1lb3V0czogW10sXG4gICAgc3RvcFRpbWVvdXRzOiBbXSxcbiAgICB1cGRhdGVUaW1lb3V0czogW10sXG4gICAgYmxvY2tDb3VudDogMCxcbiAgICBzdGFydENhbGxDb3VudDogMCxcbiAgICBzdG9wQ2FsbENvdW50OiAwXG4gIH07XG4gIHN0YXRlOiBCbG9ja1N0YXRlID0geyAuLi50aGlzLmRlZmF1bHRCbG9ja1N0YXRlIH07XG4gIGNsYXNzTmFtZTogc3RyaW5nO1xuICB0ZW1wbGF0ZUNvbXBSZWY6IENvbXBvbmVudFJlZjx7IG1lc3NhZ2U/OiBhbnkgfT4gfCBUZW1wbGF0ZVJlZjx7fT47XG4gIG1lc3NhZ2U6IGFueTtcblxuICBwcml2YXRlIGJsb2NrVUlTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBzZXR0aW5nczogQmxvY2tVSVNldHRpbmdzO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYmxvY2tVSTogQmxvY2tVSUluc3RhbmNlU2VydmljZSxcbiAgICBwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3Rpb25SZWY6IENoYW5nZURldGVjdG9yUmVmXG4gICkgeyB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5zZXR0aW5ncyA9IHRoaXMuYmxvY2tVSS5nZXRTZXR0aW5ncygpO1xuICAgIHRoaXMuYmxvY2tVSVN1YnNjcmlwdGlvbiA9IHRoaXMuc3Vic2NyaWJlVG9CbG9ja1VJKHRoaXMuYmxvY2tVSS5vYnNlcnZlKCkpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIHRyeSB7XG4gICAgICBpZiAoIXRoaXMudGVtcGxhdGVDbXApIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy50ZW1wbGF0ZUNtcCBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XG4gICAgICAgIHRoaXMudGVtcGxhdGVPdXRsZXQuY3JlYXRlRW1iZWRkZWRWaWV3KHRoaXMudGVtcGxhdGVDbXApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGVDb21wID0gdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeSh0aGlzLnRlbXBsYXRlQ21wKTtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZUNvbXBSZWYgPSB0aGlzLnRlbXBsYXRlT3V0bGV0LmNyZWF0ZUNvbXBvbmVudCh0ZW1wbGF0ZUNvbXApO1xuICAgICAgICB0aGlzLnVwZGF0ZUJsb2NrVGVtcGxhdGUodGhpcy5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignbmctYmxvY2stdWk6JywgZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpIHtcbiAgICB0aGlzLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9CbG9ja1VJKGJsb2NrVUkkOiBPYnNlcnZhYmxlPGFueT4pOiBTdWJzY3JpcHRpb24ge1xuICAgIHJldHVybiBibG9ja1VJJC5zdWJzY3JpYmUoZXZlbnQgPT4gdGhpcy5vbkRpc3BhdGNoZWRFdmVudChldmVudCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbkRpc3BhdGNoZWRFdmVudChldmVudDogQmxvY2tVSUV2ZW50KSB7XG4gICAgc3dpdGNoIChldmVudC5hY3Rpb24pIHtcbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuU1RBUlQ6XG4gICAgICAgIHRoaXMub25TdGFydChldmVudCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlNUT1A6XG4gICAgICAgIHRoaXMub25TdG9wKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuVVBEQVRFOlxuICAgICAgICB0aGlzLm9uVXBkYXRlKGV2ZW50KTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgQmxvY2tVSUFjdGlvbnMuUkVTRVQ6XG4gICAgICAgIHRoaXMub25SZXNldChldmVudCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlJFU0VUX0dMT0JBTDpcbiAgICAgICAgdGhpcy5yZXNldFN0YXRlKCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIEJsb2NrVUlBY3Rpb25zLlVOU1VCU0NSSUJFOlxuICAgICAgICB0aGlzLm9uU3RvcChldmVudCk7XG4gICAgICAgIHRoaXMub25VbnN1YnNjcmliZShldmVudC5uYW1lKTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblN0YXJ0KHsgbmFtZSwgbWVzc2FnZSB9OiBCbG9ja1VJRXZlbnQpIHtcbiAgICBpZiAobmFtZSA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICBjb25zdCBkZWxheSA9IHRoaXMuZGVsYXlTdGFydCB8fCB0aGlzLnNldHRpbmdzLmRlbGF5U3RhcnQgfHwgMDtcblxuICAgICAgdGhpcy5zdGF0ZS5zdGFydENhbGxDb3VudCArPSAxO1xuICAgICAgY29uc3Qgc3RhcnRUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc3RhdGUuYmxvY2tDb3VudCArPSAxO1xuICAgICAgICB0aGlzLnNob3dCbG9jayhtZXNzYWdlKTtcbiAgICAgICAgdGhpcy51cGRhdGVJbnN0YW5jZUJsb2NrQ291bnQoKTtcbiAgICAgIH0sIGRlbGF5KTtcbiAgICAgIHRoaXMuc3RhdGUuc3RhcnRUaW1lb3V0cy5wdXNoKHN0YXJ0VGltZW91dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvblN0b3AoeyBuYW1lIH06IEJsb2NrVUlFdmVudCkge1xuICAgIGlmIChuYW1lID09PSB0aGlzLm5hbWUpIHtcbiAgICAgIGNvbnN0IHN0b3BDb3VudCA9IHRoaXMuc3RhdGUuc3RvcENhbGxDb3VudCArIDE7XG5cbiAgICAgIGlmICh0aGlzLnN0YXRlLnN0YXJ0Q2FsbENvdW50IC0gc3RvcENvdW50ID49IDApIHtcbiAgICAgICAgY29uc3QgZGVsYXkgPSB0aGlzLmRlbGF5U3RvcCB8fCB0aGlzLnNldHRpbmdzLmRlbGF5U3RvcCB8fCAwO1xuXG4gICAgICAgIHRoaXMuc3RhdGUuc3RvcENhbGxDb3VudCA9IHN0b3BDb3VudDtcbiAgICAgICAgY29uc3Qgc3RvcFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnN0YXRlLmJsb2NrQ291bnQgLT0gMTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUluc3RhbmNlQmxvY2tDb3VudCgpO1xuICAgICAgICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgICB9LCBkZWxheSk7XG4gICAgICAgIHRoaXMuc3RhdGUuc3RvcFRpbWVvdXRzLnB1c2goc3RvcFRpbWVvdXQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25VcGRhdGUoeyBuYW1lLCBtZXNzYWdlIH06IEJsb2NrVUlFdmVudCkge1xuICAgIGlmIChuYW1lID09PSB0aGlzLm5hbWUpIHtcbiAgICAgIGNvbnN0IGRlbGF5ID0gdGhpcy5kZWxheVN0YXJ0IHx8IHRoaXMuc2V0dGluZ3MuZGVsYXlTdGFydCB8fCAwO1xuXG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5zdGF0ZS51cGRhdGVUaW1lb3V0c1swXSk7XG4gICAgICBjb25zdCB1cGRhdGVUaW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlTWVzc2FnZShtZXNzYWdlKTtcbiAgICAgIH0sIGRlbGF5KTtcbiAgICAgIHRoaXMuc3RhdGUudXBkYXRlVGltZW91dHMucHVzaCh1cGRhdGVUaW1lb3V0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uUmVzZXQoeyBuYW1lIH06IEJsb2NrVUlFdmVudCkge1xuICAgIGlmIChuYW1lID09PSB0aGlzLm5hbWUpIHtcbiAgICAgIHRoaXMucmVzZXRTdGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTWVzc2FnZShtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNob3dCbG9jayhtZXNzYWdlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd0Jsb2NrKG1lc3NhZ2U6IGFueSkge1xuICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2UgfHwgdGhpcy5kZWZhdWx0TWVzc2FnZSB8fCB0aGlzLnNldHRpbmdzLm1lc3NhZ2U7XG4gICAgdGhpcy51cGRhdGVCbG9ja1RlbXBsYXRlKHRoaXMubWVzc2FnZSk7XG4gICAgdGhpcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUJsb2NrVGVtcGxhdGUobXNnOiBhbnkpOiB2b2lkIHtcbiAgICBpZiAodGhpcy50ZW1wbGF0ZUNvbXBSZWYgJiYgdGhpcy50ZW1wbGF0ZUNvbXBSZWYgaW5zdGFuY2VvZiBDb21wb25lbnRSZWYpIHtcbiAgICAgIHRoaXMudGVtcGxhdGVDb21wUmVmLmluc3RhbmNlLm1lc3NhZ2UgPSBtc2c7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNldFN0YXRlKCkge1xuICAgIFtcbiAgICAgIC4uLnRoaXMuc3RhdGUuc3RhcnRUaW1lb3V0cyxcbiAgICAgIC4uLnRoaXMuc3RhdGUuc3RvcFRpbWVvdXRzLFxuICAgICAgLi4udGhpcy5zdGF0ZS51cGRhdGVUaW1lb3V0c1xuICAgIF0uZm9yRWFjaChjbGVhclRpbWVvdXQpO1xuICAgIHRoaXMuc3RhdGUgPSB7IC4uLnRoaXMuZGVmYXVsdEJsb2NrU3RhdGUgfTtcbiAgICB0aGlzLnVwZGF0ZUluc3RhbmNlQmxvY2tDb3VudCgpO1xuICAgIHRoaXMuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBvblVuc3Vic2NyaWJlKG5hbWU6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmJsb2NrVUlTdWJzY3JpcHRpb24gJiYgbmFtZSA9PT0gdGhpcy5uYW1lKSB7XG4gICAgICB0aGlzLmJsb2NrVUlTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUluc3RhbmNlQmxvY2tDb3VudCgpIHtcbiAgICBpZiAodGhpcy5ibG9ja1VJLmJsb2NrVUlJbnN0YW5jZXNbdGhpcy5uYW1lXSkge1xuICAgICAgY29uc3QgeyBibG9ja0NvdW50IH0gPSB0aGlzLnN0YXRlO1xuICAgICAgdGhpcy5ibG9ja1VJLmJsb2NrVUlJbnN0YW5jZXNbdGhpcy5uYW1lXS5ibG9ja0NvdW50ID0gYmxvY2tDb3VudDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRldGVjdENoYW5nZXMoKSB7XG4gICAgaWYgKCF0aGlzLmNoYW5nZURldGVjdGlvblJlZlsnZGVzdHJveWVkJ10pIHtcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0aW9uUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnJlc2V0U3RhdGUoKTtcbiAgICB0aGlzLm9uVW5zdWJzY3JpYmUodGhpcy5uYW1lKTtcbiAgICB0aGlzLmJsb2NrVUkuY2xlYXJJbnN0YW5jZSh0aGlzLm5hbWUpO1xuICB9XG59XG4iXX0=