/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Inject, PLATFORM_ID, Optional } from '@angular/core';
import { DOCUMENT, isPlatformBrowser } from '@angular/common';
import { BehaviorSubject, from, EMPTY, zip } from 'rxjs';
import { catchError, tap, map, switchMap, filter, take } from 'rxjs/operators';
import { HIGHLIGHT_OPTIONS } from './highlight.model';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "./highlight.model";
// @dynamic
import * as ɵngcc0 from '@angular/core';
export class HighlightLoader {
    /**
     * @param {?} doc
     * @param {?} platformId
     * @param {?} _options
     */
    constructor(doc, platformId, _options) {
        this._options = _options;
        // Stream that emits when hljs library is loaded and ready to use
        this._ready = new BehaviorSubject(null);
        this.ready = this._ready.asObservable().pipe(filter((/**
         * @param {?} hljs
         * @return {?}
         */
        (hljs) => !!hljs)), take(1));
        // Check if hljs is already available
        if (isPlatformBrowser(platformId) && doc.defaultView.hljs) {
            this._ready.next(doc.defaultView.hljs);
        }
        else {
            // Load hljs library
            this._loadLibrary().pipe(switchMap((/**
             * @param {?} hljs
             * @return {?}
             */
            (hljs) => {
                if (this._options && this._options.lineNumbers) {
                    // Make hljs available on window object (required for the line numbers library)
                    doc.defaultView.hljs = hljs;
                    // Load line numbers library
                    return loadLineNumbers().pipe(tap((/**
                     * @return {?}
                     */
                    () => this._ready.next(hljs))));
                }
                else {
                    this._ready.next(hljs);
                    return EMPTY;
                }
            })), catchError((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                console.error('Unable to load hljs library', e);
                return EMPTY;
            }))).subscribe();
        }
    }
    /**
     * Lazy-Load highlight.js library
     * @private
     * @return {?}
     */
    _loadLibrary() {
        return (this._options && this._options.languages && Object.keys(this._options.languages).length)
            ? from(loadCoreLibrary()).pipe(switchMap((/**
             * @param {?} hljs
             * @return {?}
             */
            (hljs) => this._loadLanguages(hljs))))
            : from(loadAllLibrary());
    }
    /**
     * Lazy-load highlight.js languages
     * @private
     * @param {?} hljs
     * @return {?}
     */
    _loadLanguages(hljs) {
        /** @type {?} */
        const languages = Object.entries(this._options.languages).map((/**
         * @param {?} __0
         * @return {?}
         */
        ([langName, langLoader]) => importModule(langLoader()).pipe(tap((/**
         * @param {?} langFunc
         * @return {?}
         */
        (langFunc) => hljs.registerLanguage(langName, langFunc))))));
        return zip(...languages).pipe(map((/**
         * @return {?}
         */
        () => hljs)));
    }
}
HighlightLoader.ɵfac = function HighlightLoader_Factory(t) { return new (t || HighlightLoader)(ɵngcc0.ɵɵinject(DOCUMENT), ɵngcc0.ɵɵinject(PLATFORM_ID), ɵngcc0.ɵɵinject(HIGHLIGHT_OPTIONS, 8)); };
HighlightLoader.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: HighlightLoader, factory: HighlightLoader.ɵfac, providedIn: 'root' });
/** @nocollapse */
HighlightLoader.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Object, decorators: [{ type: Inject, args: [PLATFORM_ID,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HIGHLIGHT_OPTIONS,] }] }
];
/** @nocollapse */ HighlightLoader.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function HighlightLoader_Factory() { return new HighlightLoader(i0.ɵɵinject(i1.DOCUMENT), i0.ɵɵinject(i0.PLATFORM_ID), i0.ɵɵinject(i2.HIGHLIGHT_OPTIONS, 8)); }, token: HighlightLoader, providedIn: "root" });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(HighlightLoader, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: undefined, decorators: [{
                type: Inject,
                args: [DOCUMENT]
            }] }, { type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }, { type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HIGHLIGHT_OPTIONS]
            }] }]; }, null); })();
if (false) {
    /**
     * @type {?}
     * @private
     */
    HighlightLoader.prototype._ready;
    /** @type {?} */
    HighlightLoader.prototype.ready;
    /**
     * @type {?}
     * @private
     */
    HighlightLoader.prototype._options;
}
/**
 * Import highlight.js core library
 * @return {?}
 */
function loadCoreLibrary() {
    return importModule(import('highlight.js/lib/highlight'));
}
/**
 * Import highlight.js library with all languages
 * @return {?}
 */
function loadAllLibrary() {
    return importModule(import('highlight.js'));
}
/**
 * Import line numbers library
 * @return {?}
 */
function loadLineNumbers() {
    return importModule(import('highlightjs-line-numbers.js'));
}
/**
 * Map loader response to module object
 * @type {?}
 */
const importModule = (/**
 * @param {?} moduleLoader
 * @return {?}
 */
(moduleLoader) => {
    return from(moduleLoader).pipe(filter((/**
     * @param {?} module
     * @return {?}
     */
    (module) => !!module && !!module.default)), map((/**
     * @param {?} module
     * @return {?}
     */
    (module) => module.default)));
});
const ɵ0 = importModule;
export { ɵ0 };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0LmxvYWRlci5qcyIsInNvdXJjZXMiOlsibmd4LWhpZ2hsaWdodGpzL2xpYi9oaWdobGlnaHQubG9hZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsZUFBZSxFQUFjLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQy9FLE9BQU8sRUFBRSxpQkFBaUIsRUFBc0MsTUFBTSxtQkFBbUIsQ0FBQztBQUMxRjtBQUdRO0FBRWM7QUFDVTs7QUFEaEMsTUFBTSxPQUFPLGVBQWU7QUFDNUI7QUFBUztBQUF1QjtBQUE4QjtBQUN6QztBQUFTLElBTTVCLFlBQThCLEdBQVEsRUFDTCxVQUFrQixFQUNRLFFBQTBCO0FBQ3ZGLFFBRDZELGFBQVEsR0FBUixRQUFRLENBQWtCO0FBQUU7QUFFNUQsUUFWVixXQUFNLEdBQUcsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdEQsUUFBVyxVQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQzlDLE1BQU07QUFBTztBQUE0QjtBQUc1QztBQUNXLFFBSkQsQ0FBQyxJQUFzQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFDLEVBQzFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FDUixDQUFDO0FBQ0osUUFJSSxxQ0FBcUM7QUFDekMsUUFBSSxJQUFJLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFO0FBQy9ELFlBQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QyxTQUFLO0FBQUUsYUFBSTtBQUNYLFlBQU0sb0JBQW9CO0FBQzFCLFlBQU0sSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLElBQUksQ0FDdEIsU0FBUztBQUFPO0FBQ2pCO0FBQTRCO0FBQWlCLFlBRGxDLENBQUMsSUFBc0IsRUFBRSxFQUFFO0FBQzdDLGdCQUFVLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRTtBQUMxRCxvQkFBWSwrRUFBK0U7QUFDM0Ysb0JBQVksR0FBRyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ3hDLG9CQUFZLDRCQUE0QjtBQUN4QyxvQkFBWSxPQUFPLGVBQWUsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHO0FBQU87QUFDM0M7QUFDSyxvQkFGZ0MsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDO0FBQzdFLGlCQUFXO0FBQUUscUJBQUk7QUFDakIsb0JBQVksSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDbkMsb0JBQVksT0FBTyxLQUFLLENBQUM7QUFDekIsaUJBQVc7QUFDWCxZQUFRLENBQUMsRUFBQyxFQUNGLFVBQVU7QUFBTztBQUNMO0FBQTRCO0FBQzNDLFlBRmMsQ0FBQyxDQUFNLEVBQUUsRUFBRTtBQUM5QixnQkFBVSxPQUFPLENBQUMsS0FBSyxDQUFDLDZCQUE2QixFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzFELGdCQUFVLE9BQU8sS0FBSyxDQUFDO0FBQ3ZCLFlBQVEsQ0FBQyxFQUFDLENBQ0gsQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUNwQixTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0g7QUFFQTtBQUNFO0FBQ1U7QUFBb0I7QUFBUyxJQUEvQixZQUFZO0FBQU0sUUFDeEIsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztBQUNwRyxZQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUztBQUFPO0FBQWdDO0FBQzVFO0FBQWlCLFlBRHFCLENBQUMsSUFBc0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBQyxDQUFDO0FBQ3RHLFlBQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBQy9CLElBQUUsQ0FBQztBQUNIO0FBRUE7QUFDRTtBQUNVO0FBQXdCO0FBQW9CO0FBQVMsSUFBdkQsY0FBYyxDQUFDLElBQXNCO0FBQUs7QUFDM0MsY0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUc7QUFBTztBQUNwRTtBQUF3QjtBQUMzQixRQUZpRSxDQUFDLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxFQUFFLEVBQUUsQ0FDdkYsWUFBWSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUM3QixHQUFHO0FBQU87QUFBZ0M7QUFBd0I7QUFFdkUsUUFGUyxDQUFDLFFBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsRUFBQyxDQUNsRSxFQUNGO0FBQ0wsUUFBSSxPQUFPLEdBQUcsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHO0FBQU87QUFLNUM7QUFBYSxRQUx5QixHQUFHLEVBQUUsQ0FBQyxJQUFJLEVBQUMsQ0FBQyxDQUFDO0FBQ25ELElBQUUsQ0FBQztBQUNIOzZDQTNEQyxVQUFVLFNBQUMsbUJBQ1YsVUFBVSxFQUFFLE1BQU0sZUFDbkI7aUlBQ0k7QUFBRTtBQUFvQjtBQUNVLDRDQU90QixNQUFNLFNBQUMsUUFBUTtBQUFVLHlDQUN6QixNQUFNLFNBQUMsV0FBVztBQUFVLDRDQUM1QixRQUFRLFlBQUksTUFBTSxTQUFDLGlCQUFpQjtBQUFTO0FBQUk7Ozs7Ozs7Ozs7Ozs7Ozs7O2tDQU85QjtBQUFFO0FBQ25DO0FBQVM7QUFBa0I7QUFBaUI7QUFBUyxJQWhCcEQsaUNBQW9EO0FBQ3REO0FBQXNCLElBQXBCLGdDQUdFO0FBQ0o7QUFDTztBQUFrQjtBQUFpQjtBQUNsQyxJQUNNLG1DQUF5RTtBQUFFO0FBQ3pGO0FBQUs7QUFBcUM7QUFDM0I7QUFpRGYsU0FBUyxlQUFlO0FBQU0sSUFDNUIsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQztBQUM1RCxDQUFDO0FBQ0Q7QUFDRztBQUM4QztBQUV4QztBQUFULFNBQVMsY0FBYztBQUFNLElBQzNCLE9BQU8sWUFBWSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDO0FBQzlDLENBQUM7QUFDRDtBQUNHO0FBQzJCO0FBRXJCO0FBQVQsU0FBUyxlQUFlO0FBQU0sSUFDNUIsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUFDLENBQUMsQ0FBQztBQUM3RCxDQUFDO0FBQ0Q7QUFDRztBQUNvQztBQUVoQztBQUFLLE1BQU4sWUFBWTtBQUFTO0FBQTRCO0FBQWdCO0FBQWxELENBQUMsWUFBMEIsRUFBbUIsRUFBRTtBQUNyRSxJQUFFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FDNUIsTUFBTTtBQUFPO0FBQTBCO0FBQ3hDO0FBQVMsSUFERCxDQUFDLE1BQVcsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBQyxFQUNyRCxHQUFHO0FBQU87QUFBMEI7QUFHaEM7QUFBUyxJQUhULENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFDLENBQ3JDLENBQUM7QUFDSixDQUFDLENBQUE7QUFDRDs7QUFsR0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFNQSxBQUFBLEFBQUEsQUFBQSxBQVFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQVJBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUtBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQ0EsQUFBQSxBQUtBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFDQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQ0EsQUFBQSxBQTFEQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBU0EsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQVJBLEFBQUEsQUFDQSxBQUdBLEFBSUEsQUFBQSxBQW1EQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFLQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUNBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFBQSxBQUFBLEFBQUEsQUFDQSxBQUFBLEFBQ0EsQUFBQSxBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBQTEFURk9STV9JRCwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRE9DVU1FTlQsIGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcclxuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBmcm9tLCBFTVBUWSwgemlwIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHRhcCwgbWFwLCBzd2l0Y2hNYXAsIGZpbHRlciwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgSElHSExJR0hUX09QVElPTlMsIEhpZ2hsaWdodExpYnJhcnksIEhpZ2hsaWdodE9wdGlvbnMgfSBmcm9tICcuL2hpZ2hsaWdodC5tb2RlbCc7XHJcblxyXG4vLyBAZHluYW1pY1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBIaWdobGlnaHRMb2FkZXIge1xyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gaGxqcyBsaWJyYXJ5IGlzIGxvYWRlZCBhbmQgcmVhZHkgdG8gdXNlXHJcbiAgcHJpdmF0ZSByZWFkb25seSBfcmVhZHkgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xyXG4gIHJlYWRvbmx5IHJlYWR5ID0gdGhpcy5fcmVhZHkuYXNPYnNlcnZhYmxlKCkucGlwZShcclxuICAgIGZpbHRlcigoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4gISFobGpzKSxcclxuICAgIHRha2UoMSlcclxuICApO1xyXG5cclxuICBjb25zdHJ1Y3RvcihASW5qZWN0KERPQ1VNRU5UKSBkb2M6IGFueSxcclxuICAgICAgICAgICAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwbGF0Zm9ybUlkOiBvYmplY3QsXHJcbiAgICAgICAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChISUdITElHSFRfT1BUSU9OUykgcHJpdmF0ZSBfb3B0aW9uczogSGlnaGxpZ2h0T3B0aW9ucykge1xyXG4gICAgLy8gQ2hlY2sgaWYgaGxqcyBpcyBhbHJlYWR5IGF2YWlsYWJsZVxyXG4gICAgaWYgKGlzUGxhdGZvcm1Ccm93c2VyKHBsYXRmb3JtSWQpICYmIGRvYy5kZWZhdWx0Vmlldy5obGpzKSB7XHJcbiAgICAgIHRoaXMuX3JlYWR5Lm5leHQoZG9jLmRlZmF1bHRWaWV3LmhsanMpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gTG9hZCBobGpzIGxpYnJhcnlcclxuICAgICAgdGhpcy5fbG9hZExpYnJhcnkoKS5waXBlKFxyXG4gICAgICAgIHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMuX29wdGlvbnMgJiYgdGhpcy5fb3B0aW9ucy5saW5lTnVtYmVycykge1xyXG4gICAgICAgICAgICAvLyBNYWtlIGhsanMgYXZhaWxhYmxlIG9uIHdpbmRvdyBvYmplY3QgKHJlcXVpcmVkIGZvciB0aGUgbGluZSBudW1iZXJzIGxpYnJhcnkpXHJcbiAgICAgICAgICAgIGRvYy5kZWZhdWx0Vmlldy5obGpzID0gaGxqcztcclxuICAgICAgICAgICAgLy8gTG9hZCBsaW5lIG51bWJlcnMgbGlicmFyeVxyXG4gICAgICAgICAgICByZXR1cm4gbG9hZExpbmVOdW1iZXJzKCkucGlwZSh0YXAoKCkgPT4gdGhpcy5fcmVhZHkubmV4dChobGpzKSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVhZHkubmV4dChobGpzKTtcclxuICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIGNhdGNoRXJyb3IoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5lcnJvcignVW5hYmxlIHRvIGxvYWQgaGxqcyBsaWJyYXJ5JywgZSk7XHJcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgfSlcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExhenktTG9hZCBoaWdobGlnaHQuanMgbGlicmFyeVxyXG4gICAqL1xyXG4gIHByaXZhdGUgX2xvYWRMaWJyYXJ5KCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gKHRoaXMuX29wdGlvbnMgJiYgdGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMgJiYgT2JqZWN0LmtleXModGhpcy5fb3B0aW9ucy5sYW5ndWFnZXMpLmxlbmd0aClcclxuICAgICAgPyBmcm9tKGxvYWRDb3JlTGlicmFyeSgpKS5waXBlKHN3aXRjaE1hcCgoaGxqczogSGlnaGxpZ2h0TGlicmFyeSkgPT4gdGhpcy5fbG9hZExhbmd1YWdlcyhobGpzKSkpXHJcbiAgICAgIDogZnJvbShsb2FkQWxsTGlicmFyeSgpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExhenktbG9hZCBoaWdobGlnaHQuanMgbGFuZ3VhZ2VzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBfbG9hZExhbmd1YWdlcyhobGpzOiBIaWdobGlnaHRMaWJyYXJ5KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGxhbmd1YWdlcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMuX29wdGlvbnMubGFuZ3VhZ2VzKS5tYXAoKFtsYW5nTmFtZSwgbGFuZ0xvYWRlcl0pID0+XHJcbiAgICAgIGltcG9ydE1vZHVsZShsYW5nTG9hZGVyKCkpLnBpcGUoXHJcbiAgICAgICAgdGFwKChsYW5nRnVuYzogYW55KSA9PiBobGpzLnJlZ2lzdGVyTGFuZ3VhZ2UobGFuZ05hbWUsIGxhbmdGdW5jKSlcclxuICAgICAgKVxyXG4gICAgKTtcclxuICAgIHJldHVybiB6aXAoLi4ubGFuZ3VhZ2VzKS5waXBlKG1hcCgoKSA9PiBobGpzKSk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogSW1wb3J0IGhpZ2hsaWdodC5qcyBjb3JlIGxpYnJhcnlcclxuICovXHJcbmZ1bmN0aW9uIGxvYWRDb3JlTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcclxuICByZXR1cm4gaW1wb3J0TW9kdWxlKGltcG9ydCgnaGlnaGxpZ2h0LmpzL2xpYi9oaWdobGlnaHQnKSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbXBvcnQgaGlnaGxpZ2h0LmpzIGxpYnJhcnkgd2l0aCBhbGwgbGFuZ3VhZ2VzXHJcbiAqL1xyXG5mdW5jdGlvbiBsb2FkQWxsTGlicmFyeSgpOiBPYnNlcnZhYmxlPEhpZ2hsaWdodExpYnJhcnk+IHtcclxuICByZXR1cm4gaW1wb3J0TW9kdWxlKGltcG9ydCgnaGlnaGxpZ2h0LmpzJykpO1xyXG59XHJcblxyXG4vKipcclxuICogSW1wb3J0IGxpbmUgbnVtYmVycyBsaWJyYXJ5XHJcbiAqL1xyXG5mdW5jdGlvbiBsb2FkTGluZU51bWJlcnMoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICByZXR1cm4gaW1wb3J0TW9kdWxlKGltcG9ydCgnaGlnaGxpZ2h0anMtbGluZS1udW1iZXJzLmpzJykpO1xyXG59XHJcblxyXG4vKipcclxuICogTWFwIGxvYWRlciByZXNwb25zZSB0byBtb2R1bGUgb2JqZWN0XHJcbiAqL1xyXG5jb25zdCBpbXBvcnRNb2R1bGUgPSAobW9kdWxlTG9hZGVyOiBQcm9taXNlPGFueT4pOiBPYnNlcnZhYmxlPGFueT4gPT4ge1xyXG4gIHJldHVybiBmcm9tKG1vZHVsZUxvYWRlcikucGlwZShcclxuICAgIGZpbHRlcigobW9kdWxlOiBhbnkpID0+ICEhbW9kdWxlICYmICEhbW9kdWxlLmRlZmF1bHQpLFxyXG4gICAgbWFwKChtb2R1bGU6IGFueSkgPT4gbW9kdWxlLmRlZmF1bHQpXHJcbiAgKTtcclxufTtcclxuIl19