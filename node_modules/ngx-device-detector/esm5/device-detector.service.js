import * as tslib_1 from "tslib";
/**
 * Created by ahsanayaz on 08/11/2016.
 */
import { PLATFORM_ID, Inject, Injectable } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import * as Constants from './device-detector.constants';
import { ReTree } from './retree';
import * as ɵngcc0 from '@angular/core';
var DeviceDetectorService = /** @class */ (function () {
    function DeviceDetectorService(platformId) {
        this.platformId = platformId;
        this.ua = '';
        this.userAgent = '';
        this.os = '';
        this.browser = '';
        this.device = '';
        this.os_version = '';
        this.browser_version = '';
        this.reTree = new ReTree();
        if (isPlatformBrowser(this.platformId)) {
            this.userAgent = window.navigator.userAgent;
        }
        this._setDeviceInfo(this.userAgent);
    }
    /**
     * @author Ahsan Ayaz
     * @desc Sets the initial value of the device when the service is initiated.
     * This value is later accessible for usage
     */
    DeviceDetectorService.prototype._setDeviceInfo = function (ua) {
        var _this = this;
        if (ua === void 0) { ua = this.userAgent; }
        if (ua !== this.userAgent) {
            this.userAgent = ua;
        }
        var mappings = [
            { const: 'OS', prop: 'os' },
            { const: 'BROWSERS', prop: 'browser' },
            { const: 'DEVICES', prop: 'device' },
            { const: 'OS_VERSIONS', prop: 'os_version' },
        ];
        mappings.forEach(function (mapping) {
            _this[mapping.prop] = Object.keys(Constants[mapping.const]).reduce(function (obj, item) {
                if (Constants[mapping.const][item] === 'device') { // hack for iOS 13 Tablet
                    if (isPlatformBrowser(_this.platformId) &&
                        (!!_this.reTree.test(_this.userAgent, Constants.TABLETS_RE['iPad']) ||
                            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1))) {
                        obj[Constants[mapping.const][item]] = 'iPad';
                        return Object;
                    }
                }
                obj[Constants[mapping.const][item]] = _this.reTree.test(ua, Constants[mapping.const + "_RE"][item]);
                return obj;
            }, {});
        });
        mappings.forEach(function (mapping) {
            _this[mapping.prop] = Object.keys(Constants[mapping.const])
                .map(function (key) {
                return Constants[mapping.const][key];
            }).reduce(function (previousValue, currentValue) {
                if (mapping.prop === 'device' && previousValue === Constants[mapping.const].ANDROID) {
                    // if we have the actual device found, instead of 'Android', return the actual device
                    return (_this[mapping.prop][currentValue])
                        ? currentValue : previousValue;
                }
                else {
                    return (previousValue === Constants[mapping.const].UNKNOWN && _this[mapping.prop][currentValue])
                        ? currentValue : previousValue;
                }
            }, Constants[mapping.const].UNKNOWN);
        });
        this.browser_version = '0';
        if (this.browser !== Constants.BROWSERS.UNKNOWN) {
            var re = Constants.BROWSER_VERSIONS_RE[this.browser];
            var res = this.reTree.exec(ua, re);
            if (!!res) {
                this.browser_version = res[1];
            }
        }
    };
    /**
     * @author Ahsan Ayaz
     * @desc Returns the device information
     * @returns the device information object.
     */
    DeviceDetectorService.prototype.getDeviceInfo = function () {
        var deviceInfo = {
            userAgent: this.userAgent,
            os: this.os,
            browser: this.browser,
            device: this.device,
            os_version: this.os_version,
            browser_version: this.browser_version
        };
        return deviceInfo;
    };
    /**
     * @author Ahsan Ayaz
     * @desc Compares the current device info with the mobile devices to check
     * if the current device is a mobile and also check current device is tablet so it will return false.
     * @returns whether the current device is a mobile
     */
    DeviceDetectorService.prototype.isMobile = function (userAgent) {
        var _this = this;
        if (userAgent === void 0) { userAgent = this.userAgent; }
        if (this.isTablet(userAgent)) {
            return false;
        }
        var match = Object.keys(Constants.MOBILES_RE).find(function (mobile) {
            return _this.reTree.test(userAgent, Constants.MOBILES_RE[mobile]);
        });
        return !!match;
    };
    ;
    /**
     * @author Ahsan Ayaz
     * @desc Compares the current device info with the tablet devices to check
     * if the current device is a tablet.
     * @returns whether the current device is a tablet
     */
    DeviceDetectorService.prototype.isTablet = function (userAgent) {
        var _this = this;
        if (userAgent === void 0) { userAgent = this.userAgent; }
        if (isPlatformBrowser(this.platformId) &&
            (!!this.reTree.test(this.userAgent, Constants.TABLETS_RE['iPad']) ||
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1))) {
            return true;
        }
        var match = Object.keys(Constants.TABLETS_RE).find(function (mobile) {
            return !!_this.reTree.test(userAgent, Constants.TABLETS_RE[mobile]);
        });
        return !!match;
    };
    ;
    /**
     * @author Ahsan Ayaz
     * @desc Compares the current device info with the desktop devices to check
     * if the current device is a desktop device.
     * @returns whether the current device is a desktop device
     */
    DeviceDetectorService.prototype.isDesktop = function (userAgent) {
        if (userAgent === void 0) { userAgent = this.userAgent; }
        var desktopDevices = [
            Constants.DEVICES.PS4,
            Constants.DEVICES.CHROME_BOOK,
            Constants.DEVICES.UNKNOWN
        ];
        if (this.device === Constants.DEVICES.UNKNOWN) {
            if (this.isMobile(userAgent) || this.isTablet(userAgent)) {
                return false;
            }
        }
        return desktopDevices.indexOf(this.device) > -1;
    };
    ;
    DeviceDetectorService = tslib_1.__decorate([ tslib_1.__param(0, Inject(PLATFORM_ID)),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], DeviceDetectorService);
DeviceDetectorService.ɵfac = function DeviceDetectorService_Factory(t) { return new (t || DeviceDetectorService)(ɵngcc0.ɵɵinject(PLATFORM_ID)); };
DeviceDetectorService.ɵprov = ɵngcc0.ɵɵdefineInjectable({ token: DeviceDetectorService, factory: function (t) { return DeviceDetectorService.ɵfac(t); } });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DeviceDetectorService, [{
        type: Injectable
    }], function () { return [{ type: Object, decorators: [{
                type: Inject,
                args: [PLATFORM_ID]
            }] }]; }, null); })();
    return DeviceDetectorService;
}());
export { DeviceDetectorService };

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLWRldGVjdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIm5neC1kZXZpY2UtZGV0ZWN0b3IvZGV2aWNlLWRldGVjdG9yLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBO0FBQ0E7QUFDQSxHQUFHO0FBQ0gsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sS0FBSyxTQUFTLE1BQU0sNkJBQTZCLENBQUM7QUFDekQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQzs7QUFZbEM7QUFFTyxJQVFILCtCQUF5QyxVQUFVO0FBQ3ZELFFBRDZDLGVBQVUsR0FBVixVQUFVLENBQUE7QUFBQyxRQVRwRCxPQUFFLEdBQUcsRUFBRSxDQUFDO0FBQ1osUUFBSSxjQUFTLEdBQUcsRUFBRSxDQUFDO0FBQ25CLFFBQUksT0FBRSxHQUFHLEVBQUUsQ0FBQztBQUNaLFFBQUksWUFBTyxHQUFHLEVBQUUsQ0FBQztBQUNqQixRQUFJLFdBQU0sR0FBRyxFQUFFLENBQUM7QUFDaEIsUUFBSSxlQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLFFBQUksb0JBQWUsR0FBRyxFQUFFLENBQUM7QUFDekIsUUFBSSxXQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztBQUMxQixRQUVRLElBQUksaUJBQWlCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQ2hELFlBQVksSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQztBQUN4RCxTQUFTO0FBQ1QsUUFBUSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM1QyxJQUFJLENBQUM7QUFDTCxJQUNJO0FBQ0o7QUFDQTtBQUNBO0FBQ0EsT0FBTztBQUNQLElBQVksOENB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QUU7QUFDdkQsWUFBWSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsRUFBRTtBQUN0RSxnQkFBZ0IsT0FBTyxLQUFLLENBQUM7QUFDN0IsYUFBYTtBQUNiLFNBQVM7QUFDVCxRQUFRLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDeEQsSUFBSSxDQUFDO0FBQ0wsSUFESyxDQUFDO0FBQ04sSUF4SmEscUJBQXFCLGdDQURqQyxVQUFVLEVBQUUsckJBQ0wsQ0FVUyxtQkFBQSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUE7QUFBRTtBQUNELE9BWHhCLHFCQUFxQixDQXdKakM7Ozs7Ozs7O2tDQUNEO0FBQUMsSUFERCw0QkFBQztBQUNBLENBREEsQUF4SkQsSUF3SkM7QUFDRCxTQXpKYSxxQkFBcUI7QUFDakMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENyZWF0ZWQgYnkgYWhzYW5heWF6IG9uIDA4LzExLzIwMTYuXG4gKi9cbmltcG9ydCB7IFBMQVRGT1JNX0lELCBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGlzUGxhdGZvcm1Ccm93c2VyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCAqIGFzIENvbnN0YW50cyBmcm9tICcuL2RldmljZS1kZXRlY3Rvci5jb25zdGFudHMnO1xuaW1wb3J0IHsgUmVUcmVlIH0gZnJvbSAnLi9yZXRyZWUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIERldmljZUluZm8ge1xuICAgIHVzZXJBZ2VudDogc3RyaW5nO1xuICAgIG9zOiBzdHJpbmc7XG4gICAgYnJvd3Nlcjogc3RyaW5nO1xuICAgIGRldmljZTogc3RyaW5nO1xuICAgIG9zX3ZlcnNpb246IHN0cmluZztcbiAgICBicm93c2VyX3ZlcnNpb246IHN0cmluZztcbn1cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERldmljZURldGVjdG9yU2VydmljZSB7XG4gICAgdWEgPSAnJztcbiAgICB1c2VyQWdlbnQgPSAnJztcbiAgICBvcyA9ICcnO1xuICAgIGJyb3dzZXIgPSAnJztcbiAgICBkZXZpY2UgPSAnJztcbiAgICBvc192ZXJzaW9uID0gJyc7XG4gICAgYnJvd3Nlcl92ZXJzaW9uID0gJyc7XG4gICAgcmVUcmVlID0gbmV3IFJlVHJlZSgpO1xuXG4gICAgY29uc3RydWN0b3IoQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkKSB7XG4gICAgICAgIGlmIChpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICAgICAgICB0aGlzLnVzZXJBZ2VudCA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50O1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3NldERldmljZUluZm8odGhpcy51c2VyQWdlbnQpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBhdXRob3IgQWhzYW4gQXlhelxuICAgICAqIEBkZXNjIFNldHMgdGhlIGluaXRpYWwgdmFsdWUgb2YgdGhlIGRldmljZSB3aGVuIHRoZSBzZXJ2aWNlIGlzIGluaXRpYXRlZC5cbiAgICAgKiBUaGlzIHZhbHVlIGlzIGxhdGVyIGFjY2Vzc2libGUgZm9yIHVzYWdlXG4gICAgICovXG4gICAgcHJpdmF0ZSBfc2V0RGV2aWNlSW5mbyh1YSA9IHRoaXMudXNlckFnZW50KSB7XG4gICAgICAgIGlmICh1YSAhPT0gdGhpcy51c2VyQWdlbnQpIHtcbiAgICAgICAgICB0aGlzLnVzZXJBZ2VudCA9IHVhO1xuICAgICAgICB9XG4gICAgICAgIGxldCBtYXBwaW5ncyA9IFtcbiAgICAgICAgICAgIHsgY29uc3QgOiAnT1MnICwgcHJvcDogJ29zJ30sXG4gICAgICAgICAgICB7IGNvbnN0IDogJ0JST1dTRVJTJyAsIHByb3A6ICdicm93c2VyJ30sXG4gICAgICAgICAgICB7IGNvbnN0IDogJ0RFVklDRVMnICwgcHJvcDogJ2RldmljZSd9LFxuICAgICAgICAgICAgeyBjb25zdCA6ICdPU19WRVJTSU9OUycgLCBwcm9wOiAnb3NfdmVyc2lvbid9LFxuICAgICAgICBdO1xuXG4gICAgICAgIG1hcHBpbmdzLmZvckVhY2goKG1hcHBpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXNbbWFwcGluZy5wcm9wXSA9IE9iamVjdC5rZXlzKENvbnN0YW50c1ttYXBwaW5nLmNvbnN0XSkucmVkdWNlKChvYmo6IGFueSwgaXRlbTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKENvbnN0YW50c1ttYXBwaW5nLmNvbnN0XVtpdGVtXSA9PT0gJ2RldmljZScpIHsgLy8gaGFjayBmb3IgaU9TIDEzIFRhYmxldFxuICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpICYmXG4gICAgICAgICAgICAgICAgICAgIChcbiAgICAgICAgICAgICAgICAgICAgICAhIXRoaXMucmVUcmVlLnRlc3QodGhpcy51c2VyQWdlbnQsIENvbnN0YW50cy5UQUJMRVRTX1JFWydpUGFkJ10pIHx8XG4gICAgICAgICAgICAgICAgICAgICAgKG5hdmlnYXRvci5wbGF0Zm9ybSA9PT0gJ01hY0ludGVsJyAmJiBuYXZpZ2F0b3IubWF4VG91Y2hQb2ludHMgPiAxKVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgICAgICAgb2JqW0NvbnN0YW50c1ttYXBwaW5nLmNvbnN0XVtpdGVtXV0gPSAnaVBhZCc7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3Q7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG9ialtDb25zdGFudHNbbWFwcGluZy5jb25zdF1baXRlbV1dID0gdGhpcy5yZVRyZWUudGVzdCh1YSwgQ29uc3RhbnRzW2Ake21hcHBpbmcuY29uc3R9X1JFYF1baXRlbV0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBvYmo7XG4gICAgICAgICAgICB9LCB7fSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIG1hcHBpbmdzLmZvckVhY2goKG1hcHBpbmcpID0+IHtcbiAgICAgICAgICAgIHRoaXNbbWFwcGluZy5wcm9wXSA9IE9iamVjdC5rZXlzKENvbnN0YW50c1ttYXBwaW5nLmNvbnN0XSlcbiAgICAgICAgICAgIC5tYXAoKGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBDb25zdGFudHNbbWFwcGluZy5jb25zdF1ba2V5XTtcbiAgICAgICAgICAgIH0pLnJlZHVjZSgocHJldmlvdXNWYWx1ZSwgY3VycmVudFZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChtYXBwaW5nLnByb3AgPT09ICdkZXZpY2UnICYmIHByZXZpb3VzVmFsdWUgPT09IENvbnN0YW50c1ttYXBwaW5nLmNvbnN0XS5BTkRST0lEKSB7XG4gICAgICAgICAgICAgICAgLy8gaWYgd2UgaGF2ZSB0aGUgYWN0dWFsIGRldmljZSBmb3VuZCwgaW5zdGVhZCBvZiAnQW5kcm9pZCcsIHJldHVybiB0aGUgYWN0dWFsIGRldmljZVxuICAgICAgICAgICAgICAgIHJldHVybiAodGhpc1ttYXBwaW5nLnByb3BdW2N1cnJlbnRWYWx1ZV0pXG4gICAgICAgICAgICAgICAgICA/IGN1cnJlbnRWYWx1ZSA6IHByZXZpb3VzVmFsdWU7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChwcmV2aW91c1ZhbHVlID09PSBDb25zdGFudHNbbWFwcGluZy5jb25zdF0uVU5LTk9XTiAmJiB0aGlzW21hcHBpbmcucHJvcF1bY3VycmVudFZhbHVlXSlcbiAgICAgICAgICAgICAgICAgID8gY3VycmVudFZhbHVlIDogcHJldmlvdXNWYWx1ZTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgQ29uc3RhbnRzW21hcHBpbmcuY29uc3RdLlVOS05PV04pO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmJyb3dzZXJfdmVyc2lvbiA9ICcwJztcbiAgICAgICAgaWYgKHRoaXMuYnJvd3NlciAhPT0gQ29uc3RhbnRzLkJST1dTRVJTLlVOS05PV04pIHtcbiAgICAgICAgICAgIGxldCByZSA9IENvbnN0YW50cy5CUk9XU0VSX1ZFUlNJT05TX1JFW3RoaXMuYnJvd3Nlcl07XG4gICAgICAgICAgICBsZXQgcmVzID0gdGhpcy5yZVRyZWUuZXhlYyh1YSwgcmUpO1xuICAgICAgICAgICAgaWYgKCEhcmVzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5icm93c2VyX3ZlcnNpb24gPSByZXNbMV07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAYXV0aG9yIEFoc2FuIEF5YXpcbiAgICAgKiBAZGVzYyBSZXR1cm5zIHRoZSBkZXZpY2UgaW5mb3JtYXRpb25cbiAgICAgKiBAcmV0dXJucyB0aGUgZGV2aWNlIGluZm9ybWF0aW9uIG9iamVjdC5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0RGV2aWNlSW5mbygpOiBEZXZpY2VJbmZvIHtcbiAgICAgICAgY29uc3QgZGV2aWNlSW5mbzogRGV2aWNlSW5mbyA9IHtcbiAgICAgICAgICAgIHVzZXJBZ2VudDogdGhpcy51c2VyQWdlbnQsXG4gICAgICAgICAgICBvcyA6IHRoaXMub3MsXG4gICAgICAgICAgICBicm93c2VyOiB0aGlzLmJyb3dzZXIsXG4gICAgICAgICAgICBkZXZpY2UgOiB0aGlzLmRldmljZSxcbiAgICAgICAgICAgIG9zX3ZlcnNpb246IHRoaXMub3NfdmVyc2lvbixcbiAgICAgICAgICAgIGJyb3dzZXJfdmVyc2lvbjogdGhpcy5icm93c2VyX3ZlcnNpb25cbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGRldmljZUluZm87XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAgICogQGRlc2MgQ29tcGFyZXMgdGhlIGN1cnJlbnQgZGV2aWNlIGluZm8gd2l0aCB0aGUgbW9iaWxlIGRldmljZXMgdG8gY2hlY2tcbiAgICAgKiBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSBtb2JpbGUgYW5kIGFsc28gY2hlY2sgY3VycmVudCBkZXZpY2UgaXMgdGFibGV0IHNvIGl0IHdpbGwgcmV0dXJuIGZhbHNlLlxuICAgICAqIEByZXR1cm5zIHdoZXRoZXIgdGhlIGN1cnJlbnQgZGV2aWNlIGlzIGEgbW9iaWxlXG4gICAgICovXG4gICAgcHVibGljIGlzTW9iaWxlKHVzZXJBZ2VudCA9IHRoaXMudXNlckFnZW50KTogYm9vbGVhbiB7XG4gICAgICBpZiAodGhpcy5pc1RhYmxldCh1c2VyQWdlbnQpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1hdGNoID0gT2JqZWN0LmtleXMoQ29uc3RhbnRzLk1PQklMRVNfUkUpLmZpbmQoKG1vYmlsZSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZVRyZWUudGVzdCh1c2VyQWdlbnQsIENvbnN0YW50cy5NT0JJTEVTX1JFW21vYmlsZV0pO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gISFtYXRjaDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAgICogQGRlc2MgQ29tcGFyZXMgdGhlIGN1cnJlbnQgZGV2aWNlIGluZm8gd2l0aCB0aGUgdGFibGV0IGRldmljZXMgdG8gY2hlY2tcbiAgICAgKiBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSB0YWJsZXQuXG4gICAgICogQHJldHVybnMgd2hldGhlciB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSB0YWJsZXRcbiAgICAgKi9cbiAgICBwdWJsaWMgaXNUYWJsZXQodXNlckFnZW50ID0gdGhpcy51c2VyQWdlbnQpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIGlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkgJiZcbiAgICAgICAgICAoXG4gICAgICAgICAgICAhIXRoaXMucmVUcmVlLnRlc3QodGhpcy51c2VyQWdlbnQsIENvbnN0YW50cy5UQUJMRVRTX1JFWydpUGFkJ10pIHx8XG4gICAgICAgICAgICAobmF2aWdhdG9yLnBsYXRmb3JtID09PSAnTWFjSW50ZWwnICYmIG5hdmlnYXRvci5tYXhUb3VjaFBvaW50cyA+IDEpXG4gICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtYXRjaCA9IE9iamVjdC5rZXlzKENvbnN0YW50cy5UQUJMRVRTX1JFKS5maW5kKChtb2JpbGUpID0+IHtcbiAgICAgICAgICByZXR1cm4gISF0aGlzLnJlVHJlZS50ZXN0KHVzZXJBZ2VudCwgQ29uc3RhbnRzLlRBQkxFVFNfUkVbbW9iaWxlXSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gISFtYXRjaDtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogQGF1dGhvciBBaHNhbiBBeWF6XG4gICAgICogQGRlc2MgQ29tcGFyZXMgdGhlIGN1cnJlbnQgZGV2aWNlIGluZm8gd2l0aCB0aGUgZGVza3RvcCBkZXZpY2VzIHRvIGNoZWNrXG4gICAgICogaWYgdGhlIGN1cnJlbnQgZGV2aWNlIGlzIGEgZGVza3RvcCBkZXZpY2UuXG4gICAgICogQHJldHVybnMgd2hldGhlciB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSBkZXNrdG9wIGRldmljZVxuICAgICAqL1xuICAgIHB1YmxpYyBpc0Rlc2t0b3AodXNlckFnZW50ID0gdGhpcy51c2VyQWdlbnQpIHtcbiAgICAgICAgY29uc3QgZGVza3RvcERldmljZXMgPSBbXG4gICAgICAgICAgICBDb25zdGFudHMuREVWSUNFUy5QUzQsXG4gICAgICAgICAgICBDb25zdGFudHMuREVWSUNFUy5DSFJPTUVfQk9PSyxcbiAgICAgICAgICAgIENvbnN0YW50cy5ERVZJQ0VTLlVOS05PV05cbiAgICAgICAgXTtcbiAgICAgICAgaWYgKHRoaXMuZGV2aWNlID09PSBDb25zdGFudHMuREVWSUNFUy5VTktOT1dOKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5pc01vYmlsZSh1c2VyQWdlbnQpIHx8IHRoaXMuaXNUYWJsZXQodXNlckFnZW50KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZGVza3RvcERldmljZXMuaW5kZXhPZih0aGlzLmRldmljZSkgPiAtMTtcbiAgICB9O1xufVxuIl19